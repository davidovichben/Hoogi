<div class="distribution-page" dir="rtl">
  <!-- Back Button -->
  <div class="flex items-center mb-2">
    <button class="btn-back" (click)="goBack()">
      <span class="arrow-icon">â†’</span>
      ×—×–×•×¨
    </button>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="text-right">
      <h1 class="page-title">
        <span>ğŸ“¤</span> ×”×¤×¦×ª ×©××œ×•× ×™×
      </h1>
      <p class="page-subtitle">
        ×¦×•×¨ ×§×™×©×•×¨×™ ×”×¤×¦×” ×œ×©××œ×•× ×™× ×©×œ×š ×•×©×ª×£ ××•×ª× ×¢× ×”×œ×§×•×—×•×ª
      </p>
    </div>
  </div>

  <!-- Main Card -->
  <div class="main-card">
    <!-- Survey Selection -->
    <div class="survey-selection-card">
      <h2 class="section-title">{{ lang.t('distribution.chooseQuestionnaire') }}</h2>
      <select
        [(ngModel)]="selectedQuestionnaire"
        (ngModelChange)="onQuestionnaireChange()"
        class="select-input"
        name="questionnaire">
        <option value="">{{ lang.t('distribution.selectPlaceholder') }}</option>
        @for (q of questionnaires; track q.id) {
          <option [value]="q.id">{{ q.title }}</option>
        }
      </select>
    </div>

    <!-- Customer Response Section -->
    <div class="customer-response-card">
      <div class="mb-6">
        <div class="card-header-row">
          <h3 class="section-subtitle">××¢× ×” ××•×˜×•××˜×™</h3>
          <button
            class="btn-create-template"
            [disabled]="!selectedQuestionnaire"
            (click)="navigateToAutomations()">
            <span class="plus-icon">+</span>
            ×¦×•×¨ ×ª×‘× ×™×ª ×—×“×©×”
            <span class="external-icon">â†—</span>
          </button>
        </div>
        <p class="help-text text-right">
          × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×¢×“ 3 ×ª×‘× ×™×•×ª. ×›×œ ×ª×‘× ×™×ª × ×™×ª×Ÿ ×œ×©×™×™×š ×œ×¢×¨×•×¥ ××—×“ ××• ×™×•×ª×¨ (××™×™×œ, ×•×•××˜×¡××¤, SMS). ×¢×¨×•×¥ ×©×¡×•××Ÿ ×‘×ª×‘× ×™×ª ××—×ª ×œ× ×™×•×¤×™×¢ ×‘×ª×‘× ×™×•×ª ××—×¨×•×ª.
        </p>
      </div>

      <!-- Selected Templates Display -->
      @if (selectedTemplates.length > 0) {
        <div class="mb-6 space-y-3">
          <label class="template-label">×ª×‘× ×™×•×ª ×©× ×‘×—×¨×• ({{ selectedTemplates.length }}/3)</label>
          <div class="space-y-3">
            @for (template of selectedTemplates; track $index; let idx = $index) {
              <div class="template-item">
                <!-- Template Name and Remove Button -->
                <div class="template-header-row">
                  <div class="flex items-center gap-2">
                    <span class="template-name">{{ template.name }}</span>
                  </div>
                  <button
                    class="btn-remove"
                    (click)="removeTemplate(idx)">
                    ×”×¡×¨
                  </button>
                </div>

                <!-- Channel Selection -->
                <div class="channels-section">
                  <label class="channels-label">×¢×¨×•×¦×™ ×©×œ×™×—×”</label>
                  <div class="channels-grid">
                    <!-- Email -->
                    <div
                      class="channel-card"
                      [class.selected]="template.channels.includes('email')"
                      [class.available]="!template.channels.includes('email') && !isChannelUsedByOtherTemplates(idx, 'email')"
                      [class.disabled]="!template.channels.includes('email') && isChannelUsedByOtherTemplates(idx, 'email')"
                      (click)="(!isChannelUsedByOtherTemplates(idx, 'email') || template.channels.includes('email')) && toggleChannelForTemplate(idx, 'email')">
                      <input
                        type="checkbox"
                        [checked]="template.channels.includes('email')"
                        [disabled]="!template.channels.includes('email') && isChannelUsedByOtherTemplates(idx, 'email')"
                        class="channel-checkbox">
                      <span class="channel-icon">âœ‰ï¸</span>
                      <span class="channel-label">××™×™×œ</span>
                    </div>

                    <!-- WhatsApp -->
                    <div
                      class="channel-card"
                      [class.selected]="template.channels.includes('whatsapp')"
                      [class.available]="!template.channels.includes('whatsapp') && !isChannelUsedByOtherTemplates(idx, 'whatsapp')"
                      [class.disabled]="!template.channels.includes('whatsapp') && isChannelUsedByOtherTemplates(idx, 'whatsapp')"
                      (click)="(!isChannelUsedByOtherTemplates(idx, 'whatsapp') || template.channels.includes('whatsapp')) && toggleChannelForTemplate(idx, 'whatsapp')">
                      <input
                        type="checkbox"
                        [checked]="template.channels.includes('whatsapp')"
                        [disabled]="!template.channels.includes('whatsapp') && isChannelUsedByOtherTemplates(idx, 'whatsapp')"
                        class="channel-checkbox">
                      <span class="channel-icon">ğŸ’¬</span>
                      <span class="channel-label">×•×•××˜×¡××¤</span>
                    </div>

                    <!-- SMS -->
                    <div
                      class="channel-card"
                      [class.selected]="template.channels.includes('sms')"
                      [class.available]="!template.channels.includes('sms') && !isChannelUsedByOtherTemplates(idx, 'sms')"
                      [class.disabled]="!template.channels.includes('sms') && isChannelUsedByOtherTemplates(idx, 'sms')"
                      (click)="(!isChannelUsedByOtherTemplates(idx, 'sms') || template.channels.includes('sms')) && toggleChannelForTemplate(idx, 'sms')">
                      <input
                        type="checkbox"
                        [checked]="template.channels.includes('sms')"
                        [disabled]="!template.channels.includes('sms') && isChannelUsedByOtherTemplates(idx, 'sms')"
                        class="channel-checkbox">
                      <span class="channel-icon">ğŸ“±</span>
                      <span class="channel-label">SMS</span>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Add Template - only if less than 3 and has available channels -->
      @if (selectedTemplates.length < 3 && getUsedChannels().length < 3) {
        <div class="space-y-4">
          <label class="template-label">×”×•×¡×£ ×ª×‘× ×™×ª ({{ selectedTemplates.length }}/3)</label>

          <!-- Template Selection -->
          <div class="space-y-3">
            <div>
              <label class="template-select-label">×‘×—×¨ ×ª×‘× ×™×ª ××¢× ×”</label>
              <select
                [(ngModel)]="newTemplateId"
                (ngModelChange)="addTemplate()"
                class="select-input"
                [disabled]="!selectedQuestionnaire"
                name="newTemplate">
                <option value="">{{ selectedQuestionnaire ? '×‘×—×¨ ×ª×‘× ×™×ª ××¢× ×”' : '×™×© ×œ×‘×—×•×¨ ×©××œ×•×Ÿ ×ª×—×™×œ×”' }}</option>
                @for (template of availableTemplates; track template.id) {
                  <option
                    [value]="template.id"
                    [disabled]="isTemplateAlreadySelected(template.id)">
                    {{ template.name }}{{ isTemplateAlreadySelected(template.id) ? ' (×›×‘×¨ × ×‘×—×¨×”)' : '' }}
                  </option>
                }
              </select>
            </div>
          </div>
        </div>
      }

      @if (!selectedQuestionnaire) {
        <p class="help-text">×™×© ×œ×‘×—×•×¨ ×©××œ×•×Ÿ ×›×“×™ ×œ×”×¤×¢×™×œ ××¢× ×” ××•×˜×•××˜×™.</p>
      }

      <!-- Message when all channels are used -->
      @if (selectedTemplates.length > 0 && getUsedChannels().length === 3 && selectedTemplates.length < 3) {
        <div class="warning-message">
          <p class="warning-text">
            âš ï¸ ×›×œ ×”×¢×¨×•×¦×™× ×‘×©×™××•×©. ××—×§ ×¢×¨×•×¥ ××• ×ª×‘× ×™×ª ×›×“×™ ×œ×”×•×¡×™×£ ×ª×‘× ×™×ª × ×•×¡×¤×ª.
          </p>
        </div>
      }

      @if (selectedTemplates.length > 0 && selectedQuestionnaire) {
        <div class="success-message">
          <p class="success-text">
            âœ“ ××¢× ×” ××•×˜×•××˜×™ ××•×¤×¢×œ ×¢×‘×•×¨ {{ selectedTemplates.length }} ×ª×‘× ×™×•×ª
          </p>
          <div class="success-details">
            @for (template of selectedTemplates; track $index) {
              @if (template.channels.length > 0) {
                <p>
                  â€¢ {{ template.name }}: {{ getFormattedChannels(template) }}
                </p>
              }
            }
          </div>
        </div>
      }
    </div>

    <!-- Save Distribution Button -->
    @if (selectedQuestionnaire && !currentDistribution) {
      <div class="save-distribution-section">
        <button
          class="btn-save-distribution"
          (click)="handleSaveDistribution()"
          [disabled]="loading">
          <span class="save-icon">ğŸ’¾</span>
          {{ loading ? '×©×•××¨...' : '×©××•×¨ ×”×¤×¦×”' }}
        </button>
        <p class="help-text text-center mt-2">
          ×™×© ×œ×©××•×¨ ××ª ×”×”×¤×¦×” ×œ×¤× ×™ ×™×¦×™×¨×ª ×§×™×©×•×¨×™×
        </p>
        @if (selectedTemplates.length > 0) {
          <p class="help-text text-center mt-1">
            {{ selectedTemplates.length }} ×ª×‘× ×™×•×ª × ×‘×—×¨×• ×œ××¢× ×” ××•×˜×•××˜×™
          </p>
        }
      </div>
    }

    <!-- Success Message After Save -->
    @if (currentDistribution && !currentMode) {
      <div class="distribution-saved-message">
        <p class="success-text">
          âœ“ ×”×”×¤×¦×” × ×©××¨×” ×‘×”×¦×œ×—×”! ×›×¢×ª × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×§×™×©×•×¨×™×
        </p>
      </div>
    }

    <!-- Quick Links Section - Only show after distribution is saved -->
    @if (currentDistribution) {
      <div class="quick-links-section">
        <h3 class="section-subtitle">{{ lang.t('distribution.createLinks') }}</h3>

        <div class="link-buttons-grid">
          <!-- QR Code -->
          <button
            class="link-button qr-button"
            (click)="handleBuildLink('qr')">
            <span class="link-icon">ğŸ“±</span>
            <span class="link-text">{{ lang.t('distribution.qrCode') }}</span>
          </button>

          <!-- Interactive Chat -->
          <button
            class="link-button chat-button"
            (click)="handleBuildLink('chat')">
            <span class="link-icon">ğŸ’¬</span>
            <span class="link-text">{{ lang.t('distribution.interactiveChat') }}</span>
          </button>

          <!-- Classic Form -->
          <button
            class="link-button form-button"
            (click)="handleBuildLink('form')">
            <span class="link-icon">ğŸ“‹</span>
            <span class="link-text">{{ lang.t('distribution.classicForm') }}</span>
          </button>
        </div>
      </div>
    }

    <!-- Preview Section -->
    @if (currentMode && currentUrl) {
      <div #previewSection class="preview-section">
        <div class="preview-header">
          <h3 class="section-subtitle">{{ lang.t('distribution.preview') }}</h3>
          <button class="btn-copy" (click)="handleCopyUrl()">
            {{ lang.t('distribution.copyLink') }}
          </button>
        </div>
        <div class="preview-url">
          <code>{{ currentUrl }}</code>
        </div>
      </div>
    }
  </div>
</div>
