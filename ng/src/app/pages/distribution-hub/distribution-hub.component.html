<div class="distribution-page" dir="rtl">
  <!-- Back Button -->
  <div class="flex items-center mb-2">
    <button class="btn-back" (click)="goBack()">
      <span class="arrow-icon">â†’</span>
      {{ lang.t('distribution.back') }}
    </button>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="text-right">
      <h1 class="page-title">
        <span>ğŸ“¤</span> {{ lang.t('distribution.title') }}
      </h1>
      <p class="page-subtitle">
        {{ lang.t('distribution.subtitle') }}
      </p>
    </div>
  </div>

  <!-- Main Card -->
  <div class="main-card">
    <!-- Survey Selection -->
    <div class="survey-selection-card">
      <select
        [(ngModel)]="selectedQuestionnaire"
        (ngModelChange)="onQuestionnaireChange()"
        class="select-input"
        name="questionnaire">
        <option value="">{{ lang.t('distribution.selectPlaceholder') }}</option>
        @for (q of questionnaires; track q.id) {
          <option [value]="q.id">{{ q.title }}</option>
        }
      </select>
    </div>

    <!-- Customer Response Section -->
    <div class="customer-response-card">
      <div class="mb-6">
        <div class="card-header-row">
          <h3 class="section-subtitle">{{ lang.t('distribution.autoResponse') }}</h3>
          <button
            class="btn-create-template"
            (click)="navigateToAutomations()">
            <span class="plus-icon">+</span>
            {{ lang.t('distribution.createNewTemplate') }}
            <span class="external-icon">â†—</span>
          </button>
        </div>
        <p class="help-text text-right">
          {{ lang.t('distribution.templatesInfo') }}
        </p>
      </div>

      <!-- Selected Templates Display -->
      @if (selectedTemplates.length > 0) {
        <div class="mb-6 space-y-3">
          <label class="template-label">{{ lang.t('distribution.templatesSelected') }} ({{ selectedTemplates.length }}/3)</label>
          <div class="space-y-3">
            @for (template of selectedTemplates; track $index; let idx = $index) {
              <div class="template-item">
                <!-- Template Name and Remove Button -->
                <div class="template-header-row">
                  <div class="flex items-center gap-2">
                    <span class="template-name">{{ template.name }}</span>
                    @if (template.channels.length === 0) {
                      <span class="warning-badge">âš ï¸</span>
                    }
                  </div>
                  <button
                    class="btn-remove"
                    (click)="removeTemplate(idx)">
                    {{ lang.t('distribution.remove') }}
                  </button>
                </div>

                <!-- Channel Selection -->
                <div class="channels-section">
                  <label class="channels-label">{{ lang.t('distribution.sendingChannels') }}
                    @if (template.channels.length === 0) {
                      <span class="required-indicator">*</span>
                    }
                  </label>
                  <div class="channels-grid">
                    <!-- Email -->
                    <div
                      class="channel-card"
                      [class.selected]="template.channels.includes('email')"
                      [class.available]="!template.channels.includes('email') && !isChannelUsedByOtherTemplates(idx, 'email')"
                      [class.disabled]="!template.channels.includes('email') && isChannelUsedByOtherTemplates(idx, 'email')"
                      (click)="(!isChannelUsedByOtherTemplates(idx, 'email') || template.channels.includes('email')) && toggleChannelForTemplate(idx, 'email')">
                      <input
                        type="checkbox"
                        [checked]="template.channels.includes('email')"
                        [disabled]="!template.channels.includes('email') && isChannelUsedByOtherTemplates(idx, 'email')"
                        class="channel-checkbox">
                      <span class="channel-icon">âœ‰ï¸</span>
                      <span class="channel-label">××™×™×œ</span>
                    </div>

                    <!-- WhatsApp -->
                    <div
                      class="channel-card"
                      [class.selected]="template.channels.includes('whatsapp')"
                      [class.available]="!template.channels.includes('whatsapp') && !isChannelUsedByOtherTemplates(idx, 'whatsapp')"
                      [class.disabled]="!template.channels.includes('whatsapp') && isChannelUsedByOtherTemplates(idx, 'whatsapp')"
                      (click)="(!isChannelUsedByOtherTemplates(idx, 'whatsapp') || template.channels.includes('whatsapp')) && toggleChannelForTemplate(idx, 'whatsapp')">
                      <input
                        type="checkbox"
                        [checked]="template.channels.includes('whatsapp')"
                        [disabled]="!template.channels.includes('whatsapp') && isChannelUsedByOtherTemplates(idx, 'whatsapp')"
                        class="channel-checkbox">
                      <span class="channel-icon">ğŸ’¬</span>
                      <span class="channel-label">×•×•××˜×¡××¤</span>
                    </div>

                    <!-- SMS -->
                    <div
                      class="channel-card"
                      [class.selected]="template.channels.includes('sms')"
                      [class.available]="!template.channels.includes('sms') && !isChannelUsedByOtherTemplates(idx, 'sms')"
                      [class.disabled]="!template.channels.includes('sms') && isChannelUsedByOtherTemplates(idx, 'sms')"
                      (click)="(!isChannelUsedByOtherTemplates(idx, 'sms') || template.channels.includes('sms')) && toggleChannelForTemplate(idx, 'sms')">
                      <input
                        type="checkbox"
                        [checked]="template.channels.includes('sms')"
                        [disabled]="!template.channels.includes('sms') && isChannelUsedByOtherTemplates(idx, 'sms')"
                        class="channel-checkbox">
                      <span class="channel-icon">ğŸ“±</span>
                      <span class="channel-label">SMS</span>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Add Template - only if less than 3 and has available channels -->
      @if (selectedTemplates.length < 3 && getUsedChannels().length < 3) {
        <div class="space-y-4">
          <label class="template-label">{{ lang.t('distribution.addTemplateLabel') }} ({{ selectedTemplates.length }}/3)</label>

          <!-- Template Selection -->
          <div class="space-y-3">
            <div>
              <label class="template-select-label">{{ lang.t('distribution.chooseResponseTemplate') }}</label>
              <select
                [(ngModel)]="newTemplateId"
                (ngModelChange)="addTemplate()"
                class="select-input"
                [disabled]="!selectedQuestionnaire"
                name="newTemplate">
                <option value="">{{ selectedQuestionnaire ? lang.t('distribution.chooseResponseTemplate') : lang.t('distribution.selectTemplateFirst') }}</option>
                @for (template of availableTemplates; track template.id) {
                  <option
                    [value]="template.id"
                    [disabled]="isTemplateAlreadySelected(template.id)">
                    {{ template.name }}{{ isTemplateAlreadySelected(template.id) ? ' (' + lang.t('distribution.alreadySelected') + ')' : '' }}
                  </option>
                }
              </select>
            </div>
          </div>
        </div>
      }

      @if (!selectedQuestionnaire) {
        <p class="help-text">{{ lang.t('distribution.selectQuestionnaireToActivate') }}</p>
      }

      <!-- Message when all channels are used -->
      @if (selectedTemplates.length > 0 && getUsedChannels().length === 3 && selectedTemplates.length < 3) {
        <div class="warning-message">
          <p class="warning-text">
            {{ lang.t('distribution.allChannelsInUse') }}
          </p>
        </div>
      }

      @if (selectedTemplates.length > 0 && selectedQuestionnaire) {
        <div class="success-message">
          <p class="success-text">
            {{ lang.t('distribution.autoResponseActive') }} {{ selectedTemplates.length }} {{ lang.t('distribution.templates') }}
          </p>
          <div class="success-details">
            @for (template of selectedTemplates; track $index) {
              @if (template.channels.length > 0) {
                <p>
                  â€¢ {{ template.name }}: {{ getFormattedChannels(template) }}
                </p>
              }
            }
          </div>
        </div>
      }

      <!-- Show Links Button -->
      @if (!showLinksSection) {
        <div class="show-links-section">
          <button
            class="btn-show-links"
            [disabled]="!selectedQuestionnaire"
            (click)="handleShowLinks()">
            <span class="link-icon">ğŸ”—</span>
            {{ lang.t('distribution.generateLinks') }}
          </button>
        </div>
      }
    </div>

    <!-- Quick Links Section -->
    @if (selectedQuestionnaire && showLinksSection) {
      <div class="quick-links-section">
        <h3 class="section-subtitle mb-4">{{ lang.t('distribution.createLink') }}</h3>

        <!-- Warning: No Automation -->
        @if (selectedTemplates.length === 0) {
          <div class="warning-message mb-4" style="background-color: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 12px 16px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 20px;">âš ï¸</span>
              <p style="margin: 0; color: #92400e; font-weight: 500; text-align: right;">
                ×©×™× ×œ×‘: ×œ× × ×‘×—×¨×• ×ª×‘× ×™×•×ª ××•×˜×•××¦×™×”. ×”×§×™×©×•×¨×™× ×™×¢×‘×“×•, ××š ×œ× ×™×™×©×œ×—×• ×”×•×“×¢×•×ª ××•×˜×•××˜×™×•×ª ×œ×œ×§×•×—×•×ª.
              </p>
            </div>
          </div>
        }

        <div class="quick-links-grid">
          <!-- Form Link -->
          <button
            class="quick-link-btn form-btn"
            [class.selected]="currentMode === 'form'"
            (click)="handleBuildLink('form')">
            <span class="quick-link-icon">ğŸ“‹</span>
            <span class="quick-link-label">{{ lang.t('distribution.form') }}</span>
          </button>

          <!-- Chat Link -->
          <button
            class="quick-link-btn chat-btn"
            [class.selected]="currentMode === 'chat'"
            (click)="handleBuildLink('chat')">
            <span class="quick-link-icon">ğŸ’¬</span>
            <span class="quick-link-label">{{ lang.t('distribution.chat') }}</span>
          </button>

          <!-- QR Link -->
          <button
            class="quick-link-btn qr-btn"
            [class.selected]="currentMode === 'qr'"
            (click)="handleBuildLink('qr')">
            <span class="quick-link-icon">QR</span>
            <span class="quick-link-label">{{ lang.t('distribution.qr') }}</span>
          </button>
        </div>
      </div>
    }

    <!-- Social Network Selection -->
    @if (selectedQuestionnaire && showLinksSection && currentMode) {
      <div class="social-network-section">
        <div class="section-header">
          <h3 class="section-subtitle mb-2">
            <span class="header-icon">ğŸ”—</span>
            {{ lang.t('distribution.socialNetworksTitle') }}
          </h3>
          <p class="help-text text-right mb-4">
            {{ lang.t('distribution.socialNetworksSubtitle') }}
          </p>
        </div>

        <!-- Main Networks (Top 5) -->
        <div class="networks-subsection">
          <h4 class="subsection-title">{{ lang.t('distribution.mainNetworks') }}</h4>
          <div class="main-networks-grid">
            @for (network of mainNetworks; track network.id) {
              <div class="network-item">
                <div
                  class="social-network-card {{ network.colorClass }}"
                  [class.selected]="selectedSocialNetwork === network.id"
                  (click)="selectSocialNetwork(network.id)">
                  @if (selectedSocialNetwork === network.id) {
                    <div class="selected-badge">âœ“</div>
                  }
                  <div class="social-icon">{{ network.icon }}</div>
                  <div class="social-label">{{ network.name }}</div>
                </div>
                <div class="network-info">
                  <span class="click-rate-badge">{{ network.clickRate }}</span>
                  <p class="network-description">{{ network.description }}</p>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Additional Networks -->
        <div class="networks-subsection">
          <h4 class="subsection-title">{{ lang.t('distribution.additionalNetworks') }}</h4>
          <div class="additional-networks-grid">
            @for (network of additionalNetworks; track network.id) {
              <div class="network-item">
                <div
                  class="social-network-card {{ network.colorClass }}"
                  [class.selected]="selectedSocialNetwork === network.id"
                  (click)="selectSocialNetwork(network.id)">
                  @if (selectedSocialNetwork === network.id) {
                    <div class="selected-badge">âœ“</div>
                  }
                  <div class="social-icon">{{ network.icon }}</div>
                  <div class="social-label">{{ network.name }}</div>
                </div>
                <div class="network-info">
                  <span class="click-rate-badge secondary">{{ network.clickRate }}</span>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Instructions -->
        <div class="instructions-card">
          <h4 class="instructions-title">{{ lang.t('distribution.howItWorks') }}</h4>
          <div class="instructions-list">
            <p>{{ lang.t('distribution.instruction1') }}</p>
            <p>{{ lang.t('distribution.instruction2') }}</p>
            <p>{{ lang.t('distribution.instruction3') }}</p>
            <p>{{ lang.t('distribution.instruction4') }}</p>
          </div>
        </div>
      </div>
    }
  </div>
</div>
