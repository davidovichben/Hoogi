<div class="distribution-page" dir="rtl">
  <!-- Back Button -->
  <div class="flex items-center mb-2">
    <button class="btn-back" (click)="goBack()">
      <span class="arrow-icon">→</span>
      חזור
    </button>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="text-right">
      <h1 class="page-title">
        <span>📤</span> הפצת שאלונים
      </h1>
      <p class="page-subtitle">
        צור קישורי הפצה לשאלונים שלך ושתף אותם עם הלקוחות
      </p>
    </div>
  </div>

  <!-- Main Card -->
  <div class="main-card">
    <!-- Survey Selection -->
    <div class="survey-selection-card">
      <h2 class="section-title">{{ lang.t('distribution.chooseQuestionnaire') }}</h2>
      <select
        [(ngModel)]="selectedQuestionnaire"
        (ngModelChange)="onQuestionnaireChange()"
        class="select-input"
        name="questionnaire">
        <option value="">{{ lang.t('distribution.selectPlaceholder') }}</option>
        @for (q of questionnaires; track q.id) {
          <option [value]="q.id">{{ q.title }}</option>
        }
      </select>
    </div>

    <!-- Customer Response Section -->
    <div class="customer-response-card">
      <div class="mb-6">
        <div class="card-header-row">
          <h3 class="section-subtitle">מענה אוטומטי</h3>
          <button
            class="btn-create-template"
            [disabled]="!selectedQuestionnaire"
            (click)="navigateToAutomations()">
            <span class="plus-icon">+</span>
            צור תבנית חדשה
            <span class="external-icon">↗</span>
          </button>
        </div>
        <p class="help-text text-right">
          ניתן לבחור עד 3 תבניות. כל תבנית ניתן לשייך לערוץ אחד או יותר (מייל, וואטסאפ, SMS). ערוץ שסומן בתבנית אחת לא יופיע בתבניות אחרות.
        </p>
      </div>

      <!-- Selected Templates Display -->
      @if (selectedTemplates.length > 0) {
        <div class="mb-6 space-y-3">
          <label class="template-label">תבניות שנבחרו ({{ selectedTemplates.length }}/3)</label>
          <div class="space-y-3">
            @for (template of selectedTemplates; track $index; let idx = $index) {
              <div class="template-item">
                <!-- Template Name and Remove Button -->
                <div class="template-header-row">
                  <div class="flex items-center gap-2">
                    <span class="template-name">{{ template.name }}</span>
                  </div>
                  <button
                    class="btn-remove"
                    (click)="removeTemplate(idx)">
                    הסר
                  </button>
                </div>

                <!-- Channel Selection -->
                <div class="channels-section">
                  <label class="channels-label">ערוצי שליחה</label>
                  <div class="channels-grid">
                    <!-- Email -->
                    <div
                      class="channel-card"
                      [class.selected]="template.channels.includes('email')"
                      [class.available]="!template.channels.includes('email') && !isChannelUsedByOtherTemplates(idx, 'email')"
                      [class.disabled]="!template.channels.includes('email') && isChannelUsedByOtherTemplates(idx, 'email')"
                      (click)="(!isChannelUsedByOtherTemplates(idx, 'email') || template.channels.includes('email')) && toggleChannelForTemplate(idx, 'email')">
                      <input
                        type="checkbox"
                        [checked]="template.channels.includes('email')"
                        [disabled]="!template.channels.includes('email') && isChannelUsedByOtherTemplates(idx, 'email')"
                        class="channel-checkbox">
                      <span class="channel-icon">✉️</span>
                      <span class="channel-label">מייל</span>
                    </div>

                    <!-- WhatsApp -->
                    <div
                      class="channel-card"
                      [class.selected]="template.channels.includes('whatsapp')"
                      [class.available]="!template.channels.includes('whatsapp') && !isChannelUsedByOtherTemplates(idx, 'whatsapp')"
                      [class.disabled]="!template.channels.includes('whatsapp') && isChannelUsedByOtherTemplates(idx, 'whatsapp')"
                      (click)="(!isChannelUsedByOtherTemplates(idx, 'whatsapp') || template.channels.includes('whatsapp')) && toggleChannelForTemplate(idx, 'whatsapp')">
                      <input
                        type="checkbox"
                        [checked]="template.channels.includes('whatsapp')"
                        [disabled]="!template.channels.includes('whatsapp') && isChannelUsedByOtherTemplates(idx, 'whatsapp')"
                        class="channel-checkbox">
                      <span class="channel-icon">💬</span>
                      <span class="channel-label">וואטסאפ</span>
                    </div>

                    <!-- SMS -->
                    <div
                      class="channel-card"
                      [class.selected]="template.channels.includes('sms')"
                      [class.available]="!template.channels.includes('sms') && !isChannelUsedByOtherTemplates(idx, 'sms')"
                      [class.disabled]="!template.channels.includes('sms') && isChannelUsedByOtherTemplates(idx, 'sms')"
                      (click)="(!isChannelUsedByOtherTemplates(idx, 'sms') || template.channels.includes('sms')) && toggleChannelForTemplate(idx, 'sms')">
                      <input
                        type="checkbox"
                        [checked]="template.channels.includes('sms')"
                        [disabled]="!template.channels.includes('sms') && isChannelUsedByOtherTemplates(idx, 'sms')"
                        class="channel-checkbox">
                      <span class="channel-icon">📱</span>
                      <span class="channel-label">SMS</span>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Add Template - only if less than 3 and has available channels -->
      @if (selectedTemplates.length < 3 && getUsedChannels().length < 3) {
        <div class="space-y-4">
          <label class="template-label">הוסף תבנית ({{ selectedTemplates.length }}/3)</label>

          <!-- Template Selection -->
          <div class="space-y-3">
            <div>
              <label class="template-select-label">בחר תבנית מענה</label>
              <select
                [(ngModel)]="newTemplateId"
                (ngModelChange)="addTemplate()"
                class="select-input"
                [disabled]="!selectedQuestionnaire"
                name="newTemplate">
                <option value="">{{ selectedQuestionnaire ? 'בחר תבנית מענה' : 'יש לבחור שאלון תחילה' }}</option>
                @for (template of availableTemplates; track template.id) {
                  <option
                    [value]="template.id"
                    [disabled]="isTemplateAlreadySelected(template.id)">
                    {{ template.name }}{{ isTemplateAlreadySelected(template.id) ? ' (כבר נבחרה)' : '' }}
                  </option>
                }
              </select>
            </div>
          </div>
        </div>
      }

      @if (!selectedQuestionnaire) {
        <p class="help-text">יש לבחור שאלון כדי להפעיל מענה אוטומטי.</p>
      }

      <!-- Message when all channels are used -->
      @if (selectedTemplates.length > 0 && getUsedChannels().length === 3 && selectedTemplates.length < 3) {
        <div class="warning-message">
          <p class="warning-text">
            ⚠️ כל הערוצים בשימוש. מחק ערוץ או תבנית כדי להוסיף תבנית נוספת.
          </p>
        </div>
      }

      @if (selectedTemplates.length > 0 && selectedQuestionnaire) {
        <div class="success-message">
          <p class="success-text">
            ✓ מענה אוטומטי מופעל עבור {{ selectedTemplates.length }} תבניות
          </p>
          <div class="success-details">
            @for (template of selectedTemplates; track $index) {
              @if (template.channels.length > 0) {
                <p>
                  • {{ template.name }}: {{ getFormattedChannels(template) }}
                </p>
              }
            }
          </div>
        </div>
      }
    </div>

    <!-- Social Network Selection -->
    @if (selectedQuestionnaire) {
      <div class="social-network-section">
        <h3 class="section-subtitle">בחר מקור הפצה</h3>
        <p class="help-text text-right">
          אנא בחר היכן תשתף את הקישור לשאלון
        </p>

        <div class="social-network-grid">
          <!-- Facebook -->
          <button
            class="social-network-card facebook-card"
            [class.selected]="selectedSocialNetwork === 'facebook'"
            (click)="handleSocialNetworkSelect('facebook')">
            <span class="social-icon">📘</span>
            <span class="social-label">Facebook</span>
            @if (selectedSocialNetwork === 'facebook') {
              <span class="selected-badge">✓</span>
            }
          </button>

          <!-- Instagram -->
          <button
            class="social-network-card instagram-card"
            [class.selected]="selectedSocialNetwork === 'instagram'"
            (click)="handleSocialNetworkSelect('instagram')">
            <span class="social-icon">📷</span>
            <span class="social-label">Instagram</span>
            @if (selectedSocialNetwork === 'instagram') {
              <span class="selected-badge">✓</span>
            }
          </button>

          <!-- LinkedIn -->
          <button
            class="social-network-card linkedin-card"
            [class.selected]="selectedSocialNetwork === 'linkedin'"
            (click)="handleSocialNetworkSelect('linkedin')">
            <span class="social-icon">💼</span>
            <span class="social-label">LinkedIn</span>
            @if (selectedSocialNetwork === 'linkedin') {
              <span class="selected-badge">✓</span>
            }
          </button>

          <!-- General -->
          <button
            class="social-network-card general-card"
            [class.selected]="selectedSocialNetwork === 'general'"
            (click)="handleSocialNetworkSelect('general')">
            <span class="social-icon">🌐</span>
            <span class="social-label">כללי</span>
            @if (selectedSocialNetwork === 'general') {
              <span class="selected-badge">✓</span>
            }
          </button>
        </div>
      </div>
    }

    <!-- Link Label Input (for social networks only) -->
    @if (selectedSocialNetwork && selectedSocialNetwork !== 'general' && !distributionSaved) {
      <div class="link-text-section">
        <h3 class="section-subtitle">פרטי הקישור</h3>
        <p class="help-text text-right">
          הזן את פרטי הקישור שיופיעו בתבנית המענה האוטומטי
        </p>

        <!-- Link Label Input -->
        <div class="link-input-group">
          <label class="link-input-label">תווית הקישור</label>
          <p class="link-input-help">הטקסט שיוצג לפני הקישור (לדוגמה: "למילוי השאלון", "לפרטים נוספים")</p>
          <input
            type="text"
            [(ngModel)]="linkLabel"
            placeholder="למילוי השאלון"
            class="link-text-input"
            name="linkLabel">
        </div>

        <!-- Link Text Input -->
        <div class="link-input-group">
          <label class="link-input-label">טקסט הכפתור</label>
          <p class="link-input-help">הטקסט שיוצג על כפתור הקישור במייל (לדוגמה: "לחץ כאן", "למידע נוסף")</p>
          <input
            type="text"
            [(ngModel)]="linkText"
            placeholder="לחץ כאן"
            class="link-text-input"
            name="linkText">
        </div>

        <div class="action-buttons">
          <button
            class="btn-save-link-details"
            (click)="saveLinkDetails()">
            שמור והמשך
          </button>
        </div>
      </div>
    }

    <!-- Quick Links Section - shown after social network is selected (and saved for social networks) -->
    @if (selectedSocialNetwork && (selectedSocialNetwork === 'general' || distributionSaved)) {
      <div class="quick-links-section">
        <h3 class="section-subtitle">{{ lang.t('distribution.createLinks') }}</h3>

        <div class="link-buttons-grid">
          <!-- QR Code -->
          <button
            class="link-button qr-button"
            (click)="handleBuildLink('qr')">
            <span class="link-icon">📱</span>
            <span class="link-text">{{ lang.t('distribution.qrCode') }}</span>
          </button>

          <!-- Interactive Chat -->
          <button
            class="link-button chat-button"
            (click)="handleBuildLink('chat')">
            <span class="link-icon">💬</span>
            <span class="link-text">{{ lang.t('distribution.interactiveChat') }}</span>
          </button>

          <!-- Classic Form -->
          <button
            class="link-button form-button"
            (click)="handleBuildLink('form')">
            <span class="link-icon">📋</span>
            <span class="link-text">{{ lang.t('distribution.classicForm') }}</span>
          </button>
        </div>
      </div>
    }

    <!-- Preview Section -->
    @if (currentMode && currentUrl) {
      <div class="preview-section">
        <div class="preview-header">
          <h3 class="section-subtitle">{{ lang.t('distribution.preview') }}</h3>
        </div>

        <!-- URL Option -->
        <div class="preview-option">
          <h4 class="preview-option-title">קישור URL</h4>
          <div class="preview-url">
            <code>{{ currentUrl }}</code>
          </div>
          <button class="btn-copy" (click)="handleCopyUrl()">
            {{ lang.t('distribution.copyLink') }}
          </button>
        </div>

        <!-- Embed Button Option (for social networks only) -->
        @if (selectedSocialNetwork && selectedSocialNetwork !== 'general') {
          <div class="preview-option">
            <h4 class="preview-option-title">כפתור להטמעה</h4>
            <p class="preview-option-help">העתק את הקוד הזה והטמע אותו באתר או בפוסט</p>
            <div class="embed-code-container">
              <code class="embed-code">{{ getEmbedCode() }}</code>
            </div>
            <button class="btn-copy" (click)="handleCopyEmbed()">
              העתק קוד הטמעה
            </button>
          </div>
        }
      </div>
    }
  </div>
</div>
