<div class="reset-password-container">
  <div class="reset-password-card">
    <h1 class="title">{{ lang.t('updatePassword.title') }}</h1>

    <form (submit)="handleSubmit(); $event.preventDefault()" class="form">
      @if (email) {
        <div class="email-info">
          {{ lang.t('updatePassword.codeSentTo') }} <strong>{{ email }}</strong>
        </div>
      }

      @if (!isCodeComplete) {
        <div>
          <label class="label">{{ lang.t('updatePassword.sixDigitCode') }}</label>
          <div class="digits-container">
            <input
              #digit1
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              [(ngModel)]="digits[0]"
              (input)="onDigitInput($event, 0)"
              (keydown)="onDigitKeydown($event, 0)"
              (paste)="onPaste($event)"
              name="digit1"
              maxlength="1"
              autocomplete="off"
              class="digit-input"
              [class.filled]="digits[0]">
            <input
              #digit2
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              [(ngModel)]="digits[1]"
              (input)="onDigitInput($event, 1)"
              (keydown)="onDigitKeydown($event, 1)"
              (paste)="onPaste($event)"
              name="digit2"
              maxlength="1"
              autocomplete="off"
              class="digit-input"
              [class.filled]="digits[1]">
            <input
              #digit3
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              [(ngModel)]="digits[2]"
              (input)="onDigitInput($event, 2)"
              (keydown)="onDigitKeydown($event, 2)"
              (paste)="onPaste($event)"
              name="digit3"
              maxlength="1"
              autocomplete="off"
              class="digit-input"
              [class.filled]="digits[2]">
            <input
              #digit4
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              [(ngModel)]="digits[3]"
              (input)="onDigitInput($event, 3)"
              (keydown)="onDigitKeydown($event, 3)"
              (paste)="onPaste($event)"
              name="digit4"
              maxlength="1"
              autocomplete="off"
              class="digit-input"
              [class.filled]="digits[3]">
            <input
              #digit5
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              [(ngModel)]="digits[4]"
              (input)="onDigitInput($event, 4)"
              (keydown)="onDigitKeydown($event, 4)"
              (paste)="onPaste($event)"
              name="digit5"
              maxlength="1"
              autocomplete="off"
              class="digit-input"
              [class.filled]="digits[4]">
            <input
              #digit6
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              [(ngModel)]="digits[5]"
              (input)="onDigitInput($event, 5)"
              (keydown)="onDigitKeydown($event, 5)"
              (paste)="onPaste($event)"
              name="digit6"
              maxlength="1"
              autocomplete="off"
              class="digit-input"
              [class.filled]="digits[5]">
          </div>
          @if (isVerifyingCode) {
            <div class="timer verifying">
              {{ lang.t('updatePassword.verifyingCode') }}
            </div>
          } @else if (timeLeft > 0) {
            <div class="timer" [class.warning]="timeLeft <= 60">
              {{ lang.t('updatePassword.codeExpiresIn') }} {{ timeLeftFormatted }}
            </div>
          } @else if (timeLeft === 0) {
            <div class="timer expired">
              {{ lang.t('updatePassword.codeExpired') }}
            </div>
          }
        </div>

        <!-- Resend Code Section -->
        <div class="resend-section">
          @if (cooldownTimeLeft > 0) {
            <div class="cooldown-message">
              {{ lang.t('updatePassword.canResendIn') }} {{ cooldownMinutes }} {{ lang.t('updatePassword.minutes') }}
            </div>
          } @else {
            <button
              type="button"
              (click)="resendCode()"
              [disabled]="!canResend"
              class="resend-btn">
              {{ isResending ? lang.t('updatePassword.resending') : lang.t('updatePassword.resendCode') }}
            </button>
            @if (resendAttempts > 0 && resendAttempts < maxResendAttempts) {
              <div class="attempts-info">
                {{ remainingAttempts }} {{ lang.t('updatePassword.attemptsRemaining') }}
              </div>
            }
          }
        </div>
      }

      @if (isCodeComplete) {
        <div>
          <label class="label">{{ lang.t('updatePassword.newPassword') }}</label>
          <div class="password-input-wrapper">
            <input
              [type]="showPassword ? 'text' : 'password'"
              [(ngModel)]="password"
              name="password"
              required
              class="input"
              (blur)="onPasswordBlur()"
              [class.error]="passwordError">
            <button
              type="button"
              class="password-toggle-btn"
              (click)="togglePasswordVisibility()"
            >
              @if (showPassword) {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              }
            </button>
          </div>
          @if (passwordError) {
            <div class="error-text">{{ passwordError }}</div>
          }
        </div>

        <div>
          <label class="label">{{ lang.t('updatePassword.confirmPassword') }}</label>
          <div class="password-input-wrapper">
            <input
              [type]="showPasswordConfirm ? 'text' : 'password'"
              [(ngModel)]="confirmPassword"
              name="confirmPassword"
              required
              class="input"
              (blur)="onConfirmPasswordBlur()"
              [class.error]="confirmPasswordError">
            <button
              type="button"
              class="password-toggle-btn"
              (click)="togglePasswordConfirmVisibility()"
            >
              @if (showPasswordConfirm) {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              }
            </button>
          </div>
          @if (confirmPasswordError) {
            <div class="error-text">{{ confirmPasswordError }}</div>
          }
        </div>
      }

      <button
        type="submit"
        [disabled]="isLoading || timeLeft === 0 || !isCodeComplete || !password || !confirmPassword || !isPasswordValid"
        class="submit-btn">
        {{ isLoading ? lang.t('updatePassword.resetting') : lang.t('updatePassword.resetPassword') }}
      </button>

      <button
        type="button"
        (click)="goBack()"
        class="back-btn">
        {{ lang.t('updatePassword.backToLogin') }}
      </button>
    </form>
  </div>
</div>
