<div class="h-screen flex flex-col overflow-hidden">
  <!-- Preview Header (Owner View Only) -->
  @if (isOwnerView && questionnaire) {
    <div class="bg-white border-b shadow-sm">
      <div class="max-w-4xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between" [dir]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
          <!-- Left side: Back button and Title/Description -->
          <div class="flex items-center gap-4">
            <button
              (click)="goBackToEdit()"
              class="flex items-center gap-2 px-3 py-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-md transition">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" [style.transform]="lang.currentLanguage === 'he' ? 'rotate(180deg)' : 'none'">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              <span class="text-sm">{{ lang.currentLanguage === 'he' ? '×—×–×¨×”' : 'Back' }}</span>
            </button>
            <div [class.text-right]="lang.currentLanguage === 'he'" [class.text-left]="lang.currentLanguage !== 'he'">
              <h1 class="text-2xl font-bold text-gray-900">
                {{ questionnaire.title || (lang.currentLanguage === 'he' ? '×©××œ×•×Ÿ ×œ×œ× ×©×' : 'Untitled Questionnaire') }}
              </h1>
              @if (questionnaire.description) {
                <p class="text-gray-600">{{ questionnaire.description }}</p>
              }
            </div>
          </div>

          <!-- Right side: Mode Toggle -->
          <div class="flex items-center gap-2">
            <button
              (click)="switchToFormView()"
              class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md transition border border-gray-300 text-gray-700 hover:bg-gray-50">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              {{ lang.currentLanguage === 'he' ? '×˜×•×¤×¡' : 'Form' }}
            </button>
            <button
              class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md transition bg-blue-600 text-white">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              {{ lang.currentLanguage === 'he' ? '×¦\'××˜' : 'Chat' }}
            </button>
          </div>
        </div>

        <!-- Metadata Row -->
        <div class="flex items-center gap-6 mt-4 text-sm text-gray-500" [dir]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>{{ lang.currentLanguage === 'he' ? '× ×•×¦×¨:' : 'Created:' }} {{ questionnaire.created_at | date: 'dd.MM.yyyy' }}</span>
          </div>
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>{{ questions.length }} {{ lang.currentLanguage === 'he' ? '×©××œ×•×ª' : 'Questions' }}</span>
          </div>
        </div>
      </div>
    </div>
  }

  <div class="chat-container flex-1 bg-gray-50 relative mx-auto" [class.max-w-3xl]="isOwnerView" [class.w-1/3]="!isOwnerView">
  <!-- Loading State -->
  @if (isLoading) {
    <div class="flex items-center justify-center h-full">
      <p class="text-gray-600">{{ lang.t('questionnaireLive.loadingQuestionnaire') }}</p>
    </div>
  }

  <!-- Chat Interface -->
  @if (!isLoading && questionnaire) {
    <!-- Header -->
    <div class="chat-header p-4 shadow-md z-20"  [style.background-color]="primaryColor">
      <div class="flex items-center justify-between gap-4" [style.direction]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
        @if (logoUrl && showLogo) {
          <img [src]="logoUrl" alt="Logo" class="h-10 w-10 rounded-full object-cover bg-white flex-shrink-0" />
        }
        <div class="flex-1 text-white text-center">
          <h1 class="text-xl font-bold">{{ questionnaire.title }}</h1>
          @if (questionnaire.meta?.subtitle) {
            <p class="text-sm opacity-90">{{ questionnaire.meta?.subtitle }}</p>
          }
        </div>
        @if (imageUrl && showProfileImage) {
          <img [src]="imageUrl" alt="Profile" class="h-10 w-10 rounded-full object-cover flex-shrink-0 border-2 border-white" />
        }
      </div>
    </div>

    <!-- Messages Area -->
    <div #messagesContainer class="p-4 overflow-y-auto" [style.height]="isOwnerView ? 'calc(100vh - 420px)' : 'calc(100vh - 200px)'">
      <div class="space-y-4" [style.direction]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
        @for (message of chatMessages; track $index) {
          @if (message.type === 'bot') {
            <!-- Bot Message -->
            <div class="flex items-start gap-3 justify-start">
              <div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-2xl" [style.background-color]="secondaryColor">
                {{ (logoUrl && showLogo) ? '' : 'ğŸ¤–' }}
                @if (logoUrl && showLogo) {
                  <img [src]="logoUrl" alt="Bot" class="w-full h-full rounded-full object-cover" />
                }
              </div>
              <div class="bg-white rounded-2xl px-5 py-3 shadow-md max-w-md"
                   [class.rounded-tl-sm]="lang.currentLanguage === 'he'"
                   [class.rounded-tr-sm]="lang.currentLanguage !== 'he'">
                <p class="text-gray-800">{{ message.text }}</p>
              </div>
            </div>
            <!-- Progress Indicator under question -->
            @if (message.questionIndex !== undefined && !isSubmitted && questions.length > 0) {
              <div class="text-center py-2 text-sm" [style.color]="primaryColor">
                {{ lang.currentLanguage === 'he' ? '×©××œ×”' : 'Question' }} {{ message.questionIndex + 1 }} {{ lang.currentLanguage === 'he' ? '××ª×•×š' : 'of' }} {{ questions.length }}
              </div>
            }
          } @else {
            <!-- User Message -->
            <div class="flex justify-end">
              <div class="bg-white rounded-2xl px-5 py-3 shadow-md max-w-md"
                   [class.rounded-tr-sm]="lang.currentLanguage === 'he'"
                   [class.rounded-tl-sm]="lang.currentLanguage !== 'he'">
                <p class="text-gray-800">{{ message.text }}</p>
              </div>
            </div>
          }
        }

        <!-- Current Question Options (for choice questions) -->
        @if (!isSubmitted && getCurrentQuestion() && showOptions) {
          @if (isSingleChoiceQuestion(getCurrentQuestion()!) || isMultiChoiceQuestion(getCurrentQuestion()!)) {
            <!-- Loading Spinner -->
            @if (optionsLoading) {
              <div class="flex justify-center items-center mt-4 py-6">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2" [style.border-color]="primaryColor"></div>
              </div>
            }

            <!-- Options (shown after loading) -->
            @if (!optionsLoading) {
              <div class="flex flex-col items-end gap-2 mt-4">
                @for (option of getQuestionOptions(getCurrentQuestion()!.id); track option.value) {
                  <button
                    (click)="onOptionClick(getCurrentQuestion()!, option.value)"
                    class="px-6 py-3 rounded-xl shadow-md transition-all max-w-md w-full bg-white hover:shadow-lg"
                    [class.option-selected]="isOptionSelected(getCurrentQuestion()!, option.value)"
                    [style.border]="'2px solid ' + (isOptionSelected(getCurrentQuestion()!, option.value) ? primaryColor : 'transparent')">
                    <span [style.color]="isOptionSelected(getCurrentQuestion()!, option.value) ? primaryColor : '#374151'">
                      {{ option.label }}
                    </span>
                  </button>
                }

                <!-- Skip button for single choice non-required questions -->
                @if (isSingleChoiceQuestion(getCurrentQuestion()!) && !getCurrentQuestion()!.is_required) {
                  <button
                    (click)="skipCurrentQuestion()"
                    class="px-8 py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all mt-2 bg-gray-100 text-gray-700 hover:bg-gray-200">
                    {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
                  </button>
                }

                <!-- Submit button for multi-choice -->
                @if (isMultiChoiceQuestion(getCurrentQuestion()!)) {
                  <div class="flex gap-2 mt-2">
                    <button
                      (click)="submitCurrentAnswer()"
                      class="px-8 py-3 rounded-xl text-white font-semibold shadow-md hover:shadow-lg transition-all"
                      [style.background-color]="primaryColor">
                      {{ lang.currentLanguage === 'he' ? '×”××©×š' : 'Continue' }}
                    </button>
                    @if (!getCurrentQuestion()!.is_required) {
                      <button
                        (click)="skipCurrentQuestion()"
                        class="px-8 py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
                        {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
                      </button>
                    }
                  </div>
                }
              </div>
            }
          }
        }
      </div>
    </div>

    <!-- Input Area (for text-based questions and owner navigation) -->
	  @if (!isSubmitted && getCurrentQuestion() && !isSingleChoiceQuestion(getCurrentQuestion()!) && !isMultiChoiceQuestion(getCurrentQuestion()!)) {
      <div class="bg-white border-t border-gray-200 p-4 shadow-lg">
        <div class="flex items-center gap-3" [style.direction]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
          @if (getCurrentQuestion()!.question_type === 'file') {
            <!-- File Upload -->
            <div class="flex-1">
              <input
                #fileInput
                type="file"
                (change)="onFileSelected($event)"
                class="hidden"
                id="chatFileInput" />
              <button
                (click)="fileInput.click()"
                class="w-full px-4 py-3 border-2 border-dashed rounded-lg transition-all hover:border-solid"
                [style.border-color]="primaryColor"
                [style.color]="primaryColor">
                <div class="flex items-center justify-center gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                  </svg>
                  <span class="font-medium">{{ uploadedFileName || lang.t('questionnaireLive.uploadFile') }}</span>
                </div>
              </button>
            </div>
            <button
              (click)="submitCurrentAnswer()"
              [disabled]="!uploadedFileName"
              class="w-12 h-12 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition flex-shrink-0"
              [class.opacity-50]="!uploadedFileName"
              [style.background-color]="primaryColor">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
            @if (!getCurrentQuestion()!.is_required) {
              <button
                (click)="skipCurrentQuestion()"
                class="w-12 h-12 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition flex-shrink-0"
                [title]="lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip'">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m9 18 6-6-6-6"/>
                  <path d="M9 18V6"/>
                </svg>
              </button>
            }
          } @else if (getCurrentQuestion()!.question_type === 'audio') {
            <!-- Audio Recording -->
            <div class="flex-1">
              <button
                (click)="toggleAudioRecording()"
                class="w-full px-4 py-3 border-2 rounded-lg transition-all"
                [class.border-dashed]="!isRecording"
                [class.border-solid]="isRecording"
                [style.border-color]="primaryColor"
                [style.background-color]="isRecording ? primaryColor + '22' : 'transparent'"
                [style.color]="primaryColor">
                <div class="flex items-center justify-center gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="22"></line>
                  </svg>
                  <span class="font-medium">
                    @if (isRecording) {
                      {{ lang.currentLanguage === 'he' ? '×”×§×œ×˜×”... ×œ×—×¥ ×œ×¢×¦×™×¨×”' : 'Recording... Click to stop' }}
                    } @else if (audioFileName) {
                      {{ audioFileName }}
                    } @else {
                      {{ lang.t('questionnaireLive.clickToRecord') }}
                    }
                  </span>
                </div>
              </button>
            </div>
            <button
              (click)="submitCurrentAnswer()"
              [disabled]="!audioFileName"
              class="w-12 h-12 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition flex-shrink-0"
              [class.opacity-50]="!audioFileName"
              [style.background-color]="primaryColor">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
            @if (!getCurrentQuestion()!.is_required) {
              <button
                (click)="skipCurrentQuestion()"
                class="w-12 h-12 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition flex-shrink-0"
                [title]="lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip'">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m9 18 6-6-6-6"/>
                  <path d="M9 18V6"/>
                </svg>
              </button>
            }
          } @else if (getCurrentQuestion()!.question_type === 'textarea') {
            <textarea
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              rows="3"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 resize-none"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterAnswer')"></textarea>
          } @else if (getCurrentQuestion()!.question_type === 'email') {
            <input
              type="email"
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterAnswer')" />
          } @else if (getCurrentQuestion()!.question_type === 'phone') {
            <input
              type="tel"
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterPhone')" />
          } @else if (getCurrentQuestion()!.question_type === 'number') {
            <input
              type="number"
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterNumber')" />
          } @else if (getCurrentQuestion()!.question_type === 'date') {
            <input
              type="date"
              [(ngModel)]="currentAnswer"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor" />
          } @else {
            <input
              type="text"
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterAnswer')" />
          }

          @if (getCurrentQuestion()!.question_type !== 'file' && getCurrentQuestion()!.question_type !== 'audio') {
            <button
              (click)="submitCurrentAnswer()"
              class="w-12 h-12 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition flex-shrink-0"
              [style.background-color]="primaryColor">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
            @if (!getCurrentQuestion()!.is_required) {
              <button
                (click)="skipCurrentQuestion()"
                class="w-12 h-12 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition flex-shrink-0"
                [title]="lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip'">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m9 18 6-6-6-6"/>
                  <path d="M9 18V6"/>
                </svg>
              </button>
            }
          }
        </div>
      </div>
    }

    <!-- Success Message -->
    @if (isSubmitted) {
      <div class="bg-white border-t border-gray-200 p-6 text-center">
        <div class="text-4xl mb-2" [style.color]="primaryColor">âœ“</div>
        <p class="text-lg font-semibold text-gray-800">
          {{ lang.t('questionnaireLive.thankYou') }}
        </p>
      </div>
    }
  }

  <!-- Error State -->
  @if (!isLoading && !questionnaire) {
    <div class="flex items-center justify-center h-full">
      <p class="text-red-600">{{ lang.t('questionnaireLive.failedToLoad') }}</p>
    </div>
  }
  </div>
</div>
