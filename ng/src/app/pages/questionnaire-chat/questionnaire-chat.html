<div class="h-screen flex flex-col overflow-hidden">
  <!-- Preview Header (Owner View Only) -->
  @if (isOwnerView && questionnaire) {
    <div class="bg-white border-b shadow-sm">
      <div class="max-w-4xl mx-auto px-2 sm:px-4 py-2 sm:py-4">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0" [dir]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
          <!-- Left side: Back button and Title/Description -->
          <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto">
            <button
              (click)="goBackToEdit()"
              class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-md transition text-xs sm:text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" class="sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" [style.transform]="lang.currentLanguage === 'he' ? 'rotate(180deg)' : 'none'">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              <span class="text-xs sm:text-sm">{{ lang.t('questionnaireLive.back') }}</span>
            </button>
            <div [class.text-right]="lang.currentLanguage === 'he'" [class.text-left]="lang.currentLanguage !== 'he'" class="flex-1 min-w-0">
              <h1 class="text-base sm:text-2xl font-bold text-gray-900 truncate">
                {{ questionnaire.title || lang.t('questionnaireLive.untitledQuestionnaire') }}
              </h1>
            </div>
          </div>

          <!-- Right side: Mode Toggle -->
          <div class="flex items-center gap-1 sm:gap-2 w-full sm:w-auto">
            <button
              (click)="switchToFormView()"
              class="flex items-center gap-1 sm:gap-2 px-2 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded-md transition border border-gray-300 text-gray-700 hover:bg-gray-50 flex-1 sm:flex-none justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" class="sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              <span class="hidden sm:inline">{{ lang.t('questionnaireLive.form') }}</span>
            </button>
            <button
              class="flex items-center gap-1 sm:gap-2 px-2 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-medium rounded-md transition bg-blue-600 text-white flex-1 sm:flex-none justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" class="sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <span class="hidden sm:inline">{{ lang.t('questionnaireLive.chat') }}</span>
            </button>
          </div>
        </div>

        <!-- Metadata Row -->
        <div class="flex flex-wrap items-center gap-3 sm:gap-6 mt-3 sm:mt-4 text-xs sm:text-sm text-gray-500" [dir]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
          <div class="flex items-center gap-1 sm:gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" class="sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span class="text-xs sm:text-sm">{{ lang.t('questionnaireLive.created') }} {{ questionnaire.created_at | date: 'dd.MM.yyyy' }}</span>
          </div>
          <div class="flex items-center gap-1 sm:gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" class="sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span class="text-xs sm:text-sm">{{ questions.length }} {{ lang.t('questionnaireLive.questions') }}</span>
          </div>
        </div>
      </div>
    </div>
  }

  <div class="chat-container flex-1 relative mx-auto bg-gray-50 w-full md:max-w-[56rem] overflow-x-hidden overflow-y-hidden flex flex-col">
  <!-- Loading State -->
  @if (isLoading) {
    <div class="flex items-center justify-center h-full">
      <p class="text-gray-600">{{ lang.t('questionnaireLive.loadingQuestionnaire') }}</p>
    </div>
  }

  <!-- Chat Interface -->
  @if (!isLoading && questionnaire) {
    <div class="flex flex-col flex-1 overflow-x-hidden overflow-y-hidden" [style.background-color]="backgroundColor">
      <!-- Messages Area with Header -->
      <div #messagesContainer class="p-2 sm:p-4 overflow-y-auto overflow-x-hidden flex-1 min-h-0">
        <!-- Header -->
        <div class="chat-header pb-2 mb-3 sm:mb-4 w-full">
          <!-- Single Row: Profile (Left) | Title (Center) | Logo (Right) -->
          <div class="flex flex-row items-start justify-between gap-2 sm:gap-4 w-full" [style.direction]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
            <!-- Profile Photo (Left in LTR, Right in RTL) -->
            <div class="w-16 h-16 sm:w-24 sm:h-24 md:w-32 md:h-32 flex-shrink-0 order-1">
              @if (imageUrl && showProfileImage) {
                <img [src]="imageUrl" alt="Profile" class="w-full h-full object-cover rounded-full sm:rounded-none" />
              }
            </div>

            <!-- Title & Description (Center) -->
            <div class="flex-1 text-center order-2">
              <div class="h-0.5 sm:h-1 mb-1 rounded-full" [style.background]="'linear-gradient(to right, ' + primaryColor + ', ' + secondaryColor + ')'"></div>
              @if (businessName) {
                <h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-1 sm:mb-2" [style.color]="primaryColor">{{ businessName }}</h2>
              }
              <h1 class="text-lg sm:text-xl md:text-2xl font-bold" [style.color]="secondaryColor">{{ questionnaire.title }}</h1>
              @if (questionnaire.description) {
                <p class="text-center text-sm sm:text-base px-2 sm:px-0" style="margin-bottom: 15px;" [style.color]="secondaryColor">{{ questionnaire.description }}</p>
              }
              @if (questionnaire.attachment_url) {
                <div class="text-center mt-1">
                  <img [src]="questionnaire.attachment_url" alt="Questionnaire attachment" class="w-full rounded-lg object-contain" [class.mb-4]="!questionnaire.link_url" style="max-height: 160px;" />
                  @if (questionnaire.attachment_size) {
                    <div class="text-xs text-gray-500 mt-2">({{ formatFileSize(questionnaire.attachment_size) }})</div>
                  }
                </div>
              }
              @if (questionnaire.link_url) {
                <div class="text-center mt-2 mb-4">
                  <a [href]="getExternalUrl(questionnaire.link_url)" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-6 sm:px-10 py-2.5 sm:py-3.5 text-white text-sm sm:text-base rounded-full" [style.background]="'linear-gradient(to right, ' + primaryColor + ', ' + secondaryColor + ')'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" class="sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                    </svg>
                    {{ questionnaire.link_label || lang.t('questionnaireLive.moreInfo') }}
                  </a>
                </div>
              }
            </div>

            <!-- Logo (Right in LTR, Left in RTL) -->
            <div class="w-16 h-16 sm:w-24 sm:h-24 md:w-32 md:h-32 flex-shrink-0 order-3">
              @if (logoUrl && showLogo) {
                <img [src]="logoUrl" alt="Logo" class="w-full h-full object-contain" />
              }
            </div>
          </div>
        </div>

        <!-- Messages -->
      <div class="space-y-3 sm:space-y-4" [style.direction]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
        @for (message of chatMessages; track $index) {
          <!-- Show all messages for questions user has visited (up to highestQuestionReached), or messages without questionIndex (greetings/success) -->
          @if (message.questionIndex === undefined || message.questionIndex <= highestQuestionReached) {
          @if (message.type === 'bot') {
            <!-- Bot Message -->
            <div class="flex flex-col gap-1">
              <!-- Current Question Indicator -->
              @if (message.questionIndex === currentQuestionIndex && !message.isSuccess) {
                <div class="flex items-center gap-2 px-2 py-1 rounded-lg animate-pulse" [style.background-color]="primaryColor + '20'">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: black;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <span class="text-xs sm:text-sm font-semibold" style="color: black;">
                    {{ lang.currentLanguage === 'he' ? '×©××œ×” × ×•×›×—×™×ª' : 'Current Question' }}
                  </span>
                </div>
              }
              <div class="flex items-start gap-2 sm:gap-3 justify-start">
                <div class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-full flex-shrink-0 flex items-center justify-center text-lg sm:text-xl md:text-2xl" [style.background-color]="secondaryColor">
                  {{ (logoUrl && showLogo) ? '' : 'ğŸ¤–' }}
                  @if (logoUrl && showLogo) {
                    <img [src]="logoUrl" alt="Bot" class="w-full h-full rounded-full object-cover" />
                  }
                </div>
              <div class="rounded-2xl px-3 sm:px-4 md:px-5 py-2 sm:py-3 shadow-md max-w-[85%] sm:max-w-md break-words transition-all duration-300"
                   [class.rounded-tl-sm]="lang.currentLanguage === 'he'"
                   [class.rounded-tr-sm]="lang.currentLanguage !== 'he'"
                   [class.bg-white]="!message.isSuccess"
                   [class.ring-4]="message.questionIndex === currentQuestionIndex && !message.isSuccess"
                   [class.scale-105]="message.questionIndex === currentQuestionIndex && !message.isSuccess"
                   [style.background-color]="message.isSuccess ? primaryColor : 'white'"
                   [style.ring-color]="message.questionIndex === currentQuestionIndex ? primaryColor + '40' : 'transparent'">
                @if (message.isSuccess) {
                  <div class="flex items-center gap-2 sm:gap-3">
                    <div class="text-2xl sm:text-3xl">âœ“</div>
                    <p class="text-white font-semibold text-sm sm:text-base break-words">{{ message.text }}</p>
                  </div>
                } @else {
                  <p class="text-sm sm:text-base break-words" [style.color]="primaryColor">{{ message.text }}</p>
                }

                <!-- Show options inside the bubble for choice questions -->
                @if (message.questionIndex !== undefined && !isSubmitted) {
                  @if (isSingleChoiceQuestion(questions[message.questionIndex]) || isMultiChoiceQuestion(questions[message.questionIndex])) {
                    <div class="mt-2 sm:mt-3 space-y-1.5 sm:space-y-2">
                      @for (option of getQuestionOptions(questions[message.questionIndex].id); track option.value) {
                        <div
                          (click)="message.questionIndex === currentQuestionIndex && !isScrolling ? onOptionClick(questions[message.questionIndex], option.value) : null"
                          class="py-1.5 sm:py-2 px-2 sm:px-3 rounded-lg transition-all text-sm sm:text-base break-words"
                          [class.cursor-pointer]="message.questionIndex === currentQuestionIndex && !isScrolling"
                          [class.cursor-not-allowed]="message.questionIndex !== currentQuestionIndex || isScrolling"
                          [class.opacity-50]="message.questionIndex !== currentQuestionIndex || isScrolling"
                          [class.font-semibold]="isOptionSelected(questions[message.questionIndex], option.value)"
                          [style.border]="'2px solid ' + primaryColor"
                          [style.background-color]="isOptionSelected(questions[message.questionIndex], option.value) ? primaryColor : 'transparent'"
                          [style.color]="isOptionSelected(questions[message.questionIndex], option.value) ? 'white' : primaryColor"
                          [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                          {{ option.label }}
                        </div>
                      }
                    </div>

                    <!-- Show text input if "other" is selected/checked -->
                    @if (message.questionIndex === currentQuestionIndex && hasOtherOption(questions[message.questionIndex].id)) {
                      @if ((isSingleChoiceQuestion(questions[message.questionIndex]) && isOtherSelected(questions[message.questionIndex].id)) ||
                           (isMultiChoiceQuestion(questions[message.questionIndex]) && isOtherChecked(questions[message.questionIndex].id))) {
                        <div class="mt-2 sm:mt-3">
                          <input
                            type="text"
                            [(ngModel)]="otherTextResponses[questions[message.questionIndex].id]"
                            [placeholder]="lang.currentLanguage === 'he' ? '×× × ×¤×¨×˜...' : 'Please specify...'"
                            class="w-full p-2 sm:p-2.5 text-sm sm:text-base rounded-lg border-2 bg-white focus:outline-none transition-all"
                            [style.border-color]="primaryColor"
                            [style.color]="primaryColor"
                            (click)="$event.stopPropagation()"
                          />
                        </div>
                      }
                    }

                    <!-- Submit/Skip buttons for multi-choice questions (inside bubble) - hide for last question -->
                    @if (message.questionIndex === currentQuestionIndex && isMultiChoiceQuestion(questions[message.questionIndex]) && currentQuestionIndex !== questions.length - 1) {
                      <div class="flex justify-start gap-2 mt-3 sm:mt-4">
                        <button
                          (click)="submitCurrentAnswer(); $event.stopPropagation()"
                          [disabled]="isScrolling"
                          class="px-4 sm:px-6 md:px-8 py-2 sm:py-2.5 md:py-3 text-xs sm:text-sm rounded-xl text-white shadow-md hover:shadow-lg transition-all"
                          [class.opacity-50]="isScrolling"
                          [class.cursor-not-allowed]="isScrolling"
                          [style.background-color]="primaryColor"
                          [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                          ×”××©×š
                        </button>
                        @if (currentQuestionIndex > 0) {
                          <button
                            (click)="goBackOneQuestion(); $event.stopPropagation()"
                            [disabled]="isScrolling"
                            class="px-4 sm:px-6 md:px-8 py-2 sm:py-2.5 md:py-3 text-xs sm:text-sm rounded-xl shadow-md hover:shadow-lg transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
                            [class.opacity-50]="isScrolling"
                            [class.cursor-not-allowed]="isScrolling"
                            [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                            {{ lang.currentLanguage === 'he' ? '×—×–×•×¨' : 'Back' }}
                          </button>
                        }
                        @if (!questions[message.questionIndex].is_required) {
                          <button
                            (click)="skipCurrentQuestion(); $event.stopPropagation()"
                            [disabled]="isScrolling"
                            class="px-4 sm:px-6 md:px-8 py-2 sm:py-2.5 md:py-3 text-xs sm:text-sm rounded-xl shadow-md hover:shadow-lg transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
                            [class.opacity-50]="isScrolling"
                            [class.cursor-not-allowed]="isScrolling"
                            [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                            {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
                          </button>
                        }
                      </div>
                    }

                    <!-- Submit button for single choice questions when "Other" is selected (inside bubble) -->
                    @if (message.questionIndex === currentQuestionIndex && isSingleChoiceQuestion(questions[message.questionIndex]) && isOtherSelected(questions[message.questionIndex].id)) {
                      <div class="flex justify-start gap-2 mt-3 sm:mt-4">
                        <button
                          (click)="submitCurrentAnswer(); $event.stopPropagation()"
                          [disabled]="isScrolling"
                          class="px-4 sm:px-6 md:px-8 py-2 sm:py-2.5 md:py-3 text-xs sm:text-sm rounded-xl text-white shadow-md hover:shadow-lg transition-all"
                          [class.opacity-50]="isScrolling"
                          [class.cursor-not-allowed]="isScrolling"
                          [style.background-color]="primaryColor"
                          [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                          {{ currentQuestionIndex === questions.length - 1 ? '×©×œ×—' : lang.t('questionnaireLive.continue') }}
                        </button>
                        @if (currentQuestionIndex > 0) {
                          <button
                            (click)="goBackOneQuestion(); $event.stopPropagation()"
                            [disabled]="isScrolling"
                            class="px-4 sm:px-6 md:px-8 py-2 sm:py-2.5 md:py-3 text-xs sm:text-sm rounded-xl shadow-md hover:shadow-lg transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
                            [class.opacity-50]="isScrolling"
                            [class.cursor-not-allowed]="isScrolling"
                            [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                            {{ lang.currentLanguage === 'he' ? '×—×–×•×¨' : 'Back' }}
                          </button>
                        }
                        @if (!questions[message.questionIndex].is_required) {
                          <button
                            (click)="skipCurrentQuestion(); $event.stopPropagation()"
                            [disabled]="isScrolling"
                            class="px-4 sm:px-6 md:px-8 py-2 sm:py-2.5 md:py-3 text-xs sm:text-sm rounded-xl shadow-md hover:shadow-lg transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
                            [class.opacity-50]="isScrolling"
                            [class.cursor-not-allowed]="isScrolling"
                            [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                            {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
                          </button>
                        }
                      </div>
                    }

                    <!-- Buttons for single choice questions (not "Other", any required status) - hide for last question -->
                    @if (message.questionIndex === currentQuestionIndex && isSingleChoiceQuestion(questions[message.questionIndex]) && !isOtherSelected(questions[message.questionIndex].id) && currentQuestionIndex !== questions.length - 1) {
                      <div class="flex justify-start gap-2 mt-3 sm:mt-4">
                        <!-- Continue button if question was already answered (user went back) -->
                        @if (responses[questions[message.questionIndex].id]) {
                          <button
                            (click)="submitCurrentAnswer(); $event.stopPropagation()"
                            [disabled]="isScrolling"
                            class="px-4 sm:px-6 md:px-8 py-2 sm:py-2.5 md:py-3 text-xs sm:text-sm rounded-xl text-white shadow-md hover:shadow-lg transition-all"
                            [class.opacity-50]="isScrolling"
                            [class.cursor-not-allowed]="isScrolling"
                            [style.background-color]="primaryColor"
                            [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                            ×”××©×š
                          </button>
                        }
                        @if (currentQuestionIndex > 0) {
                          <button
                            (click)="goBackOneQuestion(); $event.stopPropagation()"
                            [disabled]="isScrolling"
                            class="px-4 sm:px-6 md:px-8 py-2 sm:py-2.5 md:py-3 text-xs sm:text-sm rounded-xl shadow-md hover:shadow-lg transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
                            [class.opacity-50]="isScrolling"
                            [class.cursor-not-allowed]="isScrolling"
                            [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                            {{ lang.currentLanguage === 'he' ? '×—×–×•×¨' : 'Back' }}
                          </button>
                        }
                        @if (!questions[message.questionIndex].is_required) {
                          <button
                            (click)="skipCurrentQuestion(); $event.stopPropagation()"
                            [disabled]="isScrolling"
                            class="px-4 sm:px-6 md:px-8 py-2 sm:py-2.5 md:py-3 text-xs sm:text-sm rounded-xl shadow-md hover:shadow-lg transition-all bg-gray-100 text-gray-700 hover:bg-gray-200"
                            [class.opacity-50]="isScrolling"
                            [class.cursor-not-allowed]="isScrolling"
                            [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                            {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
                          </button>
                        }
                      </div>
                    }
                  }

                  <!-- Show rating for rating questions -->
                  @if (isRatingQuestion(questions[message.questionIndex])) {
                    <div class="mt-2 sm:mt-3 flex gap-1.5 sm:gap-2 justify-center flex-wrap">
                      @for (rating of getRatingRange(questions[message.questionIndex]); track rating) {
                        <button
                          type="button"
                          (click)="message.questionIndex === currentQuestionIndex && !isScrolling ? onOptionClick(questions[message.questionIndex], rating.toString()) : null"
                          class="w-8 h-8 sm:w-9 sm:h-9 md:w-10 md:h-10 text-sm sm:text-base rounded-full border-2 transition-all"
                          [class.cursor-pointer]="message.questionIndex === currentQuestionIndex && !isScrolling"
                          [class.cursor-not-allowed]="message.questionIndex !== currentQuestionIndex || isScrolling"
                          [class.opacity-50]="message.questionIndex !== currentQuestionIndex || isScrolling"
                          [disabled]="isScrolling"
                          [style.border-color]="primaryColor"
                          [style.color]="isOptionSelected(questions[message.questionIndex], rating.toString()) ? 'white' : primaryColor"
                          [style.background-color]="isOptionSelected(questions[message.questionIndex], rating.toString()) ? primaryColor : 'transparent'"
                          [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                          {{ rating }}
                        </button>
                      }
                    </div>
                  }

                  <!-- Show recording prompt for audio questions -->
                  @if (questions[message.questionIndex].question_type === 'audio' && message.questionIndex === currentQuestionIndex) {
                    <div class="mt-2 sm:mt-3 text-center">
                      <p class="text-xs sm:text-sm opacity-90" [style.color]="primaryColor">
                        {{ lang.currentLanguage === 'he' ? 'ğŸ¤ ×”×©×ª××© ×‘×›×¤×ª×•×¨ ×œ××˜×” ×›×“×™ ×œ×”×§×œ×™×˜ ×ª×©×•×‘×”' : 'ğŸ¤ Use the button below to record your answer' }}
                      </p>
                    </div>
                  }

                  <!-- Show file upload prompt for file questions -->
                  @if (questions[message.questionIndex].question_type === 'file' && message.questionIndex === currentQuestionIndex) {
                    <div class="mt-2 sm:mt-3 text-center">
                      <p class="text-xs sm:text-sm opacity-90" [style.color]="primaryColor">
                        {{ lang.currentLanguage === 'he' ? 'ğŸ“ ×”×©×ª××© ×‘×›×¤×ª×•×¨ ×œ××˜×” ×›×“×™ ×œ×”×¢×œ×•×ª ×§×•×‘×¥' : 'ğŸ“ Use the button below to upload a file' }}
                      </p>
                    </div>
                  }
                }
              </div>
              </div>
            </div>
          } @else {
            <!-- User Message -->
            @if (message.text) {
              <div class="flex justify-end">
                <div class="rounded-2xl px-3 sm:px-4 md:px-5 py-2 sm:py-3 shadow-md max-w-[85%] sm:max-w-md break-words bg-white"
                     [class.rounded-tr-sm]="lang.currentLanguage === 'he'"
                     [class.rounded-tl-sm]="lang.currentLanguage !== 'he'"
                     style="background-color: white;">
                  <p class="text-sm sm:text-base break-words" [style.color]="primaryColor">{{ message.text }}</p>
                </div>
              </div>
            }
          }
          }
        }
      </div>
    </div>

    <!-- Input Area (always visible in preview mode, conditionally in guest mode) -->
    @if (isOwnerView && !isSubmitted && getCurrentQuestion() && !isSingleChoiceQuestion(getCurrentQuestion()!) && !isMultiChoiceQuestion(getCurrentQuestion()!) && !isRatingQuestion(getCurrentQuestion()!)) {
      <!-- Preview mode: Show appropriate input based on question type -->
      <div class="bg-white border-t border-gray-200 p-2 sm:p-3 md:p-4 shadow-lg flex-shrink-0">
        <div class="flex flex-col gap-2">
        <div class="flex items-center gap-2 sm:gap-3" [style.direction]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
          @if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'file') {
            <!-- File Upload -->
            <div class="flex-1">
              <input
                #fileInputOwner
                type="file"
                (change)="onFileSelected($event)"
                class="hidden"
                id="chatFileInputOwner" />
              <button
                (click)="fileInputOwner.click()"
                class="w-full px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 border-2 border-dashed rounded-lg transition-all hover:border-solid text-sm sm:text-base"
                [style.border-color]="primaryColor"
                [style.color]="primaryColor">
                <div class="flex items-center justify-center gap-2 sm:gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5 md:w-6 md:h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                  </svg>
                  <span class="font-medium truncate">{{ uploadedFileName || lang.t('questionnaireLive.uploadFile') }}</span>
                </div>
              </button>
            </div>
            <!-- Submit button for file: show text for last question, icon for others -->
            @if (currentQuestionIndex === questions.length - 1) {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="!uploadedFileName || isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition"
                [class.opacity-50]="!uploadedFileName || isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                ×©×œ×—
              </button>
            } @else {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="!uploadedFileName || isScrolling"
                class="w-10 h-10 sm:w-11 sm:h-11 md:w-12 md:h-12 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition flex-shrink-0"
                [class.opacity-50]="!uploadedFileName || isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            }
            @if (!getCurrentQuestion()!.is_required) {
              <button
                (click)="skipCurrentQuestion()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition"
                [class.opacity-50]="isScrolling"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
              </button>
            }
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'audio') {
            <!-- Audio Recording -->
            <div class="flex-1">
              <button
                (click)="toggleAudioRecording()"
                [disabled]="isScrolling"
                class="w-full px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 border-2 rounded-lg transition-all text-sm sm:text-base"
                [class.border-dashed]="!isRecording"
                [class.border-solid]="isRecording"
                [class.opacity-50]="isScrolling"
                [style.border-color]="primaryColor"
                [style.background-color]="isRecording ? primaryColor + '22' : 'transparent'"
                [style.color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                <div class="flex items-center justify-center gap-2 sm:gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5 md:w-6 md:h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="22"></line>
                  </svg>
                  <span class="font-medium truncate">
                    @if (isRecording) {
                      {{ lang.t('questionnaireLive.recordingStop') }}
                    } @else if (audioFileName) {
                      {{ audioFileName }}
                    } @else {
                      {{ lang.t('questionnaireLive.clickToRecord') }}
                    }
                  </span>
                </div>
              </button>
            </div>
            <!-- Submit button for audio: show text for last question, icon for others -->
            @if (currentQuestionIndex === questions.length - 1) {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="!audioFileName || isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition"
                [class.opacity-50]="!audioFileName || isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                ×©×œ×—
              </button>
            } @else {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="!audioFileName || isScrolling"
                class="w-10 h-10 sm:w-11 sm:h-11 md:w-12 md:h-12 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition flex-shrink-0"
                [class.opacity-50]="!audioFileName || isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            }
            @if (!getCurrentQuestion()!.is_required) {
              <button
                (click)="skipCurrentQuestion()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition"
                [class.opacity-50]="isScrolling"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
              </button>
            }
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'textarea') {
            <textarea
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              rows="3"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 resize-none"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterAnswer')"></textarea>
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'email') {
            <input
              type="email"
              [(ngModel)]="currentAnswer"
              (ngModelChange)="clearCurrentAnswerError()"
              (blur)="validateCurrentAnswer()"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2"
              [class.border-red-500]="currentAnswerError"
              [class.border-gray-300]="!currentAnswerError"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterAnswer')" />
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'phone') {
            <input
              type="tel"
              [(ngModel)]="currentAnswer"
              (ngModelChange)="clearCurrentAnswerError()"
              (blur)="validateCurrentAnswer()"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2"
              [class.border-red-500]="currentAnswerError"
              [class.border-gray-300]="!currentAnswerError"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterPhone')" />
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'url') {
            <input
              type="url"
              [(ngModel)]="currentAnswer"
              (ngModelChange)="clearCurrentAnswerError()"
              (blur)="validateCurrentAnswer()"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2"
              [class.border-red-500]="currentAnswerError"
              [class.border-gray-300]="!currentAnswerError"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.currentLanguage === 'he' ? '×”×–×Ÿ ×›×ª×•×‘×ª URL (×œ×“×•×’××”: https://example.com)' : 'Enter URL (e.g., https://example.com)'" />
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'number') {
            <input
              type="number"
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterNumber')" />
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'date') {
            <input
              type="date"
              [(ngModel)]="currentAnswer"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor" />
          } @else {
            <input
              type="text"
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterAnswer')" />
          }

          @if (getCurrentQuestion() && getCurrentQuestion()!.question_type !== 'file' && getCurrentQuestion()!.question_type !== 'audio') {
            <!-- Submit button: show text for last question, icon for others -->
            @if (currentQuestionIndex === questions.length - 1) {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition"
                [class.opacity-50]="isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                ×©×œ×—
              </button>
            } @else {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="isScrolling"
                class="w-10 h-10 sm:w-11 sm:h-11 md:w-12 md:h-12 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition flex-shrink-0"
                [class.opacity-50]="isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            }
            @if (currentQuestionIndex > 0) {
              <!-- Back button: always show text -->
              <button
                (click)="goBackOneQuestion()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition"
                [class.opacity-50]="isScrolling"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                {{ lang.currentLanguage === 'he' ? '×—×–×•×¨' : 'Back' }}
              </button>
            }
            @if (!getCurrentQuestion()!.is_required) {
              <button
                (click)="skipCurrentQuestion()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition"
                [class.opacity-50]="isScrolling"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
              </button>
            }
          }
        </div>
        @if (currentAnswerError) {
          <p class="text-red-500 text-xs sm:text-sm px-2" [style.direction]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">{{ currentAnswerError }}</p>
        }
        </div>
      </div>
    } @else if (!isSubmitted && getCurrentQuestion() && !isSingleChoiceQuestion(getCurrentQuestion()!) && !isMultiChoiceQuestion(getCurrentQuestion()!) && !isRatingQuestion(getCurrentQuestion()!)) {
      <!-- Guest mode: Show input for text-based questions -->
      <div class="bg-white border-t border-gray-200 p-2 sm:p-3 md:p-4 shadow-lg flex-shrink-0">
        <div class="flex flex-col gap-2">
        <div class="flex items-center gap-2 sm:gap-3" [style.direction]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
          @if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'file') {
            <!-- File Upload -->
            <div class="flex-1">
              <input
                #fileInput
                type="file"
                (change)="onFileSelected($event)"
                class="hidden"
                id="chatFileInput" />
              <button
                (click)="fileInput.click()"
                class="w-full px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 border-2 border-dashed rounded-lg transition-all hover:border-solid text-sm sm:text-base"
                [style.border-color]="primaryColor"
                [style.color]="primaryColor">
                <div class="flex items-center justify-center gap-2 sm:gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5 md:w-6 md:h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                  </svg>
                  <span class="font-medium truncate">{{ uploadedFileName || lang.t('questionnaireLive.uploadFile') }}</span>
                </div>
              </button>
            </div>
            <!-- Submit button for file: show text for last question, icon for others -->
            @if (currentQuestionIndex === questions.length - 1) {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="!uploadedFileName || isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition"
                [class.opacity-50]="!uploadedFileName || isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                ×©×œ×—
              </button>
            } @else {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="!uploadedFileName || isScrolling"
                class="w-10 h-10 sm:w-11 sm:h-11 md:w-12 md:h-12 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition flex-shrink-0"
                [class.opacity-50]="!uploadedFileName || isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            }
            @if (!getCurrentQuestion()!.is_required) {
              <button
                (click)="skipCurrentQuestion()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition"
                [class.opacity-50]="isScrolling"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
              </button>
            }
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'audio') {
            <!-- Audio Recording -->
            <div class="flex-1">
              <button
                (click)="toggleAudioRecording()"
                [disabled]="isScrolling"
                class="w-full px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 border-2 rounded-lg transition-all text-sm sm:text-base"
                [class.border-dashed]="!isRecording"
                [class.border-solid]="isRecording"
                [class.opacity-50]="isScrolling"
                [style.border-color]="primaryColor"
                [style.background-color]="isRecording ? primaryColor + '22' : 'transparent'"
                [style.color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                <div class="flex items-center justify-center gap-2 sm:gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5 md:w-6 md:h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="22"></line>
                  </svg>
                  <span class="font-medium truncate">
                    @if (isRecording) {
                      {{ lang.t('questionnaireLive.recordingStop') }}
                    } @else if (audioFileName) {
                      {{ audioFileName }}
                    } @else {
                      {{ lang.t('questionnaireLive.clickToRecord') }}
                    }
                  </span>
                </div>
              </button>
            </div>
            <!-- Submit button for audio: show text for last question, icon for others -->
            @if (currentQuestionIndex === questions.length - 1) {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="!audioFileName || isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition"
                [class.opacity-50]="!audioFileName || isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                ×©×œ×—
              </button>
            } @else {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="!audioFileName || isScrolling"
                class="w-10 h-10 sm:w-11 sm:h-11 md:w-12 md:h-12 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition flex-shrink-0"
                [class.opacity-50]="!audioFileName || isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            }
            @if (!getCurrentQuestion()!.is_required) {
              <button
                (click)="skipCurrentQuestion()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition"
                [class.opacity-50]="isScrolling"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
              </button>
            }
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'textarea') {
            <textarea
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              rows="3"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 resize-none"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterAnswer')"></textarea>
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'email') {
            <input
              type="email"
              [(ngModel)]="currentAnswer"
              (ngModelChange)="clearCurrentAnswerError()"
              (blur)="validateCurrentAnswer()"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2"
              [class.border-red-500]="currentAnswerError"
              [class.border-gray-300]="!currentAnswerError"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterAnswer')" />
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'phone') {
            <input
              type="tel"
              [(ngModel)]="currentAnswer"
              (ngModelChange)="clearCurrentAnswerError()"
              (blur)="validateCurrentAnswer()"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2"
              [class.border-red-500]="currentAnswerError"
              [class.border-gray-300]="!currentAnswerError"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterPhone')" />
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'url') {
            <input
              type="url"
              [(ngModel)]="currentAnswer"
              (ngModelChange)="clearCurrentAnswerError()"
              (blur)="validateCurrentAnswer()"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2"
              [class.border-red-500]="currentAnswerError"
              [class.border-gray-300]="!currentAnswerError"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.currentLanguage === 'he' ? '×”×–×Ÿ ×›×ª×•×‘×ª URL (×œ×“×•×’××”: https://example.com)' : 'Enter URL (e.g., https://example.com)'" />
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'number') {
            <input
              type="number"
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterNumber')" />
          } @else if (getCurrentQuestion() && getCurrentQuestion()!.question_type === 'date') {
            <input
              type="date"
              [(ngModel)]="currentAnswer"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor" />
          } @else {
            <input
              type="text"
              [(ngModel)]="currentAnswer"
              (keydown)="onKeyPress($event)"
              class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
              [style.--focus-color]="primaryColor"
              [placeholder]="lang.t('questionnaireLive.enterAnswer')" />
          }

          @if (getCurrentQuestion() && getCurrentQuestion()!.question_type !== 'file' && getCurrentQuestion()!.question_type !== 'audio') {
            <!-- Submit button: show text for last question, icon for others -->
            @if (currentQuestionIndex === questions.length - 1) {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition"
                [class.opacity-50]="isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                ×©×œ×—
              </button>
            } @else {
              <button
                (click)="submitCurrentAnswer()"
                [disabled]="isScrolling"
                class="w-10 h-10 sm:w-11 sm:h-11 md:w-12 md:h-12 rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition flex-shrink-0"
                [class.opacity-50]="isScrolling"
                [style.background-color]="primaryColor"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" class="sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            }
            @if (currentQuestionIndex > 0) {
              <!-- Back button: always show text -->
              <button
                (click)="goBackOneQuestion()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition"
                [class.opacity-50]="isScrolling"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                {{ lang.currentLanguage === 'he' ? '×—×–×•×¨' : 'Back' }}
              </button>
            }
            @if (!getCurrentQuestion()!.is_required) {
              <button
                (click)="skipCurrentQuestion()"
                [disabled]="isScrolling"
                class="px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition"
                [class.opacity-50]="isScrolling"
                [style.pointer-events]="isScrolling ? 'none' : 'auto'">
                {{ lang.currentLanguage === 'he' ? '×“×œ×’' : 'Skip' }}
              </button>
            }
          }
        </div>
        @if (currentAnswerError) {
          <p class="text-red-500 text-xs sm:text-sm px-2" [style.direction]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">{{ currentAnswerError }}</p>
        }
        </div>
      </div>
    }

    <!-- Send button for last question when it's single/multi choice and answered (but not "Other" since that's handled in bubble) -->
    @if (shouldShowSendButton()) {
      <div class="bg-white border-t border-gray-200 p-2 sm:p-3 md:p-4 shadow-lg flex-shrink-0">
        <div class="flex justify-center gap-3">
          @if (currentQuestionIndex > 0) {
            <button
              (click)="goBackOneQuestion()"
              [disabled]="isScrolling"
              class="px-6 sm:px-8 py-3 sm:py-4 text-base sm:text-lg rounded-lg flex items-center justify-center bg-gray-100 text-gray-700 shadow-md hover:shadow-lg hover:bg-gray-200 transition font-semibold"
              [class.opacity-50]="isScrolling"
              [style.pointer-events]="isScrolling ? 'none' : 'auto'">
              ×—×–×•×¨
            </button>
          }
          <button
            (click)="submitCurrentAnswer()"
            [disabled]="isScrolling"
            class="px-8 sm:px-12 py-3 sm:py-4 text-base sm:text-lg rounded-lg flex items-center justify-center text-white shadow-md hover:shadow-lg transition font-semibold"
            [class.opacity-50]="isScrolling"
            [style.background-color]="primaryColor"
            [style.pointer-events]="isScrolling ? 'none' : 'auto'">
            ×©×œ×—
          </button>
        </div>
      </div>
    }

    <!-- Success Message -->
    @if (isSubmitted) {
      <div class="bg-white border-t border-gray-200 p-6 text-center flex-shrink-0">
        <div class="text-4xl mb-2" [style.color]="primaryColor">âœ“</div>
        <p class="text-lg font-semibold text-gray-800">
          {{ lang.t('questionnaireLive.thankYou') }}
        </p>
      </div>
    }
    </div>
  }

  <!-- Error State -->
  @if (!isLoading && !questionnaire) {
    <div class="flex items-center justify-center h-full">
      <p class="text-red-600">{{ lang.t('questionnaireLive.failedToLoad') }}</p>
    </div>
  }
  </div>
</div>
