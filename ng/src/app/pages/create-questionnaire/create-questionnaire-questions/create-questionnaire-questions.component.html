<div class="dialog-container" [dir]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'">
  <div class="flex items-center justify-between p-6 border-b">
    <h2 class="text-xl font-bold m-0">
      {{ lang.t('createQuestionnaire.buildQuestionnaire') }}
    </h2>
    <div class="flex items-center justify-end gap-3">
      <button
        (click)="addQuestion()"
        [disabled]="loadingSuggestions"
        class="px-6 py-2 text-blue-500 bg-white border border-blue-500 rounded-lg hover:bg-blue-50 transition disabled:opacity-50 disabled:cursor-not-allowed">
        + {{ lang.t('createQuestionnaire.buildQuestionnaire') }}
      </button>
      <button
        (click)="loadAiSuggestedQuestions()"
        [disabled]="loadingSuggestions || aiSuggestionsUsed"
        class="px-6 py-2 text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 justify-center">
        @if (loadingSuggestions) {
          <lucide-icon [img]="Loader2Icon" [size]="18" class="animate-spin"></lucide-icon>
        }
        <span>{{ loadingSuggestions ? lang.t('common.loading') : (aiSuggestionsUsed ? (lang.currentLanguage === 'he' ? 'נוצר בעזרת AI' : 'AI Generated') : lang.t('createQuestionnaire.aiSuggestions')) }}</span>
      </button>
      <button
        (click)="closeWithX()"
        class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition"
        [attr.aria-label]="lang.t('common.close')">
        <lucide-icon [img]="XIcon" [size]="24"></lucide-icon>
      </button>
    </div>
  </div>

  <mat-dialog-content class="!p-6">
    <div class="questions-container space-y-4">
      <!-- Questions List -->
      @for (question of questions; track question.id; let i = $index) {
        <div class="question-card bg-gray-50 rounded-lg p-6 border">

        <!-- Question Header Row -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <span class="font-semibold text-sm text-grey">Q{{ i + 1 }}</span>
            <label class="flex items-center gap-2" [class.cursor-pointer]="!question.isFixed && !loadingSuggestions" [class.cursor-not-allowed]="!!question.isFixed || loadingSuggestions">
              <input
                type="checkbox"
                [(ngModel)]="question.isRequired"
                [disabled]="!!question.isFixed || loadingSuggestions"
                class="rounded disabled:cursor-not-allowed">
              <span class="text-sm text-black" [class.text-gray-500]="!!question.isFixed || loadingSuggestions">{{ lang.t('createQuestionnaire.required') }}</span>
            </label>
          </div>

          <!-- Action Buttons -->
          <div class="flex items-center gap-1">
            <!-- Copy Button (only for non-fixed questions) -->
            @if (!question.isFixed) {
              <button
                (click)="duplicateQuestion(i)"
                [disabled]="loadingSuggestions"
                class="p-2 hover:text-blue-700 hover:bg-blue-50 rounded transition disabled:opacity-50 disabled:cursor-not-allowed"
                [attr.aria-label]="lang.t('common.duplicate')">
                <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
            }

            <!-- Delete Button (only for non-fixed questions with more than 1 non-fixed question) -->
            @if (canDeleteQuestion(question)) {
              <button
                (click)="deleteQuestion(question.id)"
                [disabled]="loadingSuggestions"
                class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition disabled:opacity-50 disabled:cursor-not-allowed"
                [attr.aria-label]="lang.t('common.delete')">
                <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            }
          </div>
        </div>

        <!-- Question Type Label -->
        <div class="mb-2 text-right">
          <label class="block text-sm font-medium text-black mb-1">
            {{ lang.t('createQuestionnaire.questionType') }}
          </label>
        </div>

        <!-- Question Type Dropdown -->
        <div class="mb-4">
          <mat-form-field class="w-full" appearance="outline">
            <mat-select
              [(ngModel)]="question.type"
              (ngModelChange)="onQuestionTypeChange(question)"
              [disabled]="!!question.isFixed || loadingSuggestions"
              class="text-right">
              <mat-select-trigger>
                <div class="flex items-center gap-2">
                  <lucide-icon [img]="getQuestionTypeIcon(question.type)" [size]="16" class="text-gray-600"></lucide-icon>
                  <span>{{ getQuestionTypeLabel(question.type) }}</span>
                </div>
              </mat-select-trigger>
              @for (type of questionTypes; track type.value) {
                <mat-option [value]="type.value">
                  <div class="flex items-center gap-2">
                    <lucide-icon [img]="type.icon" [size]="16" class="text-gray-600"></lucide-icon>
                    <span>{{ type.label }}</span>
                  </div>
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Question Text Label and Input -->
        <div class="mb-2 text-right">
          <label class="block text-sm font-medium text-black mb-1">
            {{ lang.t('createQuestionnaire.questionText') }}
          </label>
        </div>

        <!-- Question Text Input -->
        <div class="mb-4">
          <textarea
            [(ngModel)]="question.text"
            [placeholder]="lang.t('createQuestionnaire.enterQuestionHere')"
            [disabled]="!!question.isFixed || loadingSuggestions"
            rows="3"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right resize-none disabled:bg-gray-100 disabled:cursor-not-allowed"></textarea>
        </div>
	       
        <!-- Rating Min/Max Inputs -->
        @if (question.type === 'rating') {
          <div class="mb-4">
            <div class="grid grid-cols-2 gap-4">
              <!-- Minimum Rating -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-right">
                  {{ lang.t('createQuestionnaire.minimum') }}
                </label>
                <input
                  type="number"
                  [(ngModel)]="question.minRating"
                  [placeholder]="lang.t('createQuestionnaire.defaultOne')"
                  [disabled]="loadingSuggestions"
                  min="1"
                  max="5"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 text-right disabled:bg-gray-100 disabled:cursor-not-allowed"
                  [class.border-red-500]="hasRatingError(question)"
                  [class.border-gray-300]="!hasRatingError(question)"
                  [class.focus:ring-red-500]="hasRatingError(question)"
                  [class.focus:ring-blue-500]="!hasRatingError(question)">
              </div>

              <!-- Maximum Rating -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-right">
                  {{ lang.t('createQuestionnaire.maximum') }}
                </label>
                <input
                  type="number"
                  [(ngModel)]="question.maxRating"
                  [placeholder]="lang.t('createQuestionnaire.defaultFive')"
                  [disabled]="loadingSuggestions"
                  min="1"
                  max="5"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 text-right disabled:bg-gray-100 disabled:cursor-not-allowed"
                  [class.border-red-500]="hasRatingError(question)"
                  [class.border-gray-300]="!hasRatingError(question)"
                  [class.focus:ring-red-500]="hasRatingError(question)"
                  [class.focus:ring-blue-500]="!hasRatingError(question)">
              </div>
            </div>

            <!-- Error Message -->
            @if (hasRatingError(question)) {
              <div class="mt-2 text-sm text-red-600 text-right">
                {{ getRatingErrorMessage() }}
              </div>
            }
          </div>
        }

        <!-- Options for select/radio/checkbox/conditional -->
        @if (question.type === 'select' || question.type === 'radio' || question.type === 'checkbox' || question.type === 'conditional') {
          <div class="mb-4">
            <!-- Options Header -->
            <div class="mb-3 text-right">
              <label class="block text-sm font-medium text-gray-700">
                {{ lang.t('createQuestionnaire.options') }}
              </label>
            </div>

            <!-- Options List -->
            <div class="space-y-3">
              @for (option of question.options || []; track $index; let optIdx = $index) {
                <div class="flex items-center gap-3">
                  <!-- Option Label on Right -->
                  <span class="text-sm text-gray-600 whitespace-nowrap">
                    {{ lang.t('createQuestionnaire.option') }} {{ optIdx + 1 }}
                  </span>

                  <!-- Option Input -->
                  <input
                    type="text"
                    [(ngModel)]="question.options![optIdx]"
                    [placeholder]="lang.t('createQuestionnaire.optionText')"
                    [disabled]="loadingSuggestions"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right disabled:bg-gray-100 disabled:cursor-not-allowed">

                  <!-- Delete Button on Left -->
                  <button
                    (click)="question.options!.splice(optIdx, 1)"
                    [disabled]="!canDeleteOption(question) || loadingSuggestions"
                    class="p-2 text-gray-400 hover:text-red-500 transition disabled:opacity-30 disabled:cursor-not-allowed disabled:hover:text-gray-400"
                    [attr.aria-label]="lang.t('common.delete')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              }
            </div>

            <!-- Add Option Button -->
            <div class="text-center mt-4">
              <button
                (click)="addOptionToQuestionByRef(question)"
                [disabled]="loadingSuggestions"
                class="text-sm text-blue-500 hover:text-blue-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                + {{ lang.t('createQuestionnaire.addOption') }}
              </button>
            </div>
          </div>
        }

        <!-- Move Up/Down Buttons -->
        @if (!question.isFixed) {
          <div class="flex gap-2 mt-4">
            <button
              (click)="moveQuestionDown(i)"
              [disabled]="i === questions.length - 1 || (questions[i + 1]?.isFixed) || loadingSuggestions"
              class="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed">
              {{ lang.t('createQuestionnaire.moveDown') }}
            </button>
            <button
              (click)="moveQuestionUp(i)"
              [disabled]="i === 0 || (questions[i - 1]?.isFixed) || loadingSuggestions"
              class="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed">
              {{ lang.t('createQuestionnaire.moveUp') }}
            </button>
          </div>
        }
        </div>
      }
	    
	    <div>
		    <button
						    (click)="addQuestion()"
						    [disabled]="loadingSuggestions"
						    class="px-6 py-2 w-full text-blue-500 bg-white border border-blue-500 rounded-lg hover:bg-blue-50 transition disabled:opacity-50 disabled:cursor-not-allowed">
			    + {{ lang.t('createQuestionnaire.addQuestion') }}
		    </button>
	    </div>
	    
      <!-- Action Buttons -->
      <div class="flex justify-center gap-3 mt-6 pt-6 border-t">
        <button
          mat-button
          (click)="cancel()"
          [disabled]="loadingSuggestions"
          class="px-6 py-3 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition disabled:opacity-50 disabled:cursor-not-allowed">
          {{ lang.t('common.cancel') }}
        </button>
        <button
          mat-button
          (click)="showPreview()"
          [disabled]="loadingSuggestions || loadingSingleSuggestion"
          class="preview-btn disabled:opacity-50 disabled:cursor-not-allowed">
          {{ lang.t('createQuestionnaire.showPreview') }}
        </button>
        <button
          mat-button
          (click)="close()"
          [disabled]="loadingSuggestions || loadingSingleSuggestion"
          class="px-6 py-3 text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
          {{ lang.t('createQuestionnaire.saveQuestionnaire') }}
        </button>
      </div>
    </div>
  </mat-dialog-content>
</div>

<!-- Suggest Question Dialog -->
@if (showSuggestQuestionDialog) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" (click)="closeSuggestQuestionDialog()">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4" [dir]="lang.currentLanguage === 'he' ? 'rtl' : 'ltr'" (click)="$event.stopPropagation()">
      <!-- Dialog Header -->
      <div class="p-6 border-b">
        <h3 class="text-xl font-bold">
          {{ lang.t('createQuestionnaire.suggestQuestionWithAI') }}
        </h3>
      </div>

      <!-- Dialog Content -->
      <div class="p-6">
        <label class="block text-sm font-medium text-gray-700 mb-2 text-right">
          {{ lang.t('createQuestionnaire.describeQuestion') }}
        </label>
        <textarea
          [(ngModel)]="questionDescription"
          [placeholder]="lang.t('createQuestionnaire.exampleBudget')"
          rows="4"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right resize-none"></textarea>
      </div>
	    
      <!-- Dialog Actions -->
      <div class="flex justify-end gap-3 p-6 border-t">
        <button
          (click)="closeSuggestQuestionDialog()"
          class="px-6 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
          {{ lang.t('common.cancel') }}
        </button>
        <button
          (click)="suggestSingleQuestion()"
          [disabled]="loadingSingleSuggestion || !questionDescription.trim()"
          class="px-6 py-2 text-white bg-purple-500 rounded-lg hover:bg-purple-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 justify-center">
          @if (loadingSingleSuggestion) {
            <lucide-icon [img]="Loader2Icon" [size]="18" class="animate-spin"></lucide-icon>
          }
          <span>{{ loadingSingleSuggestion ? lang.t('common.loading') : lang.t('createQuestionnaire.createQuestion') }}</span>
        </button>
      </div>
    </div>
  </div>
}
